<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Câu hỏi Hội thi An toàn Vệ sinh Viên Giỏi 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .smooth-transition {
            transition: all 0.2s ease;
        }
        
        /* Tab styles */
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Drag and drop styles */
        .drag-item {
            cursor: grab;
            transition: all 0.2s ease;
        }
        .drag-item:active {
            cursor: grabbing;
        }
        .drag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .drag-over {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
        }
        
        /* Category colors for questions */
        .category-cspl { border-left: 4px solid #3b82f6; }
        .category-pccc { border-left: 4px solid #ef4444; }
        .category-bv { border-left: 4px solid #10b981; }
        .category-ktm { border-left: 4px solid #f59e0b; }
        .category-bxvc { border-left: 4px solid #8b5cf6; }
        
        /* Question preview styles */
        .question-preview {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Drop zone styles */        .drop-zone {
            min-height: 150px;
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            background-color: #f0f9ff;
            border-color: #3b82f6;
            transform: scale(1.02);
        }
        .drag-item {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .drag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .drag-over {
            border: 2px dashed #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.05) !important;
        }
        
        .question-set-item {
            transition: all 0.2s ease;
        }
        
        .question-set-item:hover {
            transform: translateY(-1px);
        }        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Round tab styles */
        .round-tab-button {
            border-color: transparent;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        .round-tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        .round-tab-button:hover {
            color: #374151;
        }
        .round-content {
            display: none;
        }
        .round-content.active {
            display: block;
        }
        
        /* Question set container styles */
        .question-set-container {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .question-set-container.drop-target {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .question-set-box {
            min-height: 120px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        .question-set-box.has-questions {
            background: #ecfccb;
            border-color: #84cc16;
        }

        /* Progress indicators and enhanced visual feedback */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1;
        }

        .progress-bar {
            flex: 1;
            height: 0.5rem;
            background: #e2e8f0;
            border-radius: 0.25rem;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 0.25rem;
            transition: width 0.3s ease;
        }

        .validation-message {
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
            animation: slideDown 0.3s ease;
        }

        .validation-message.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .validation-message.warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .validation-message.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-counter {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .counter-badge {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .set-validation-icon {
            margin-left: 0.5rem;
            font-size: 1rem;
        }

        .set-validation-icon.valid {
            color: #10b981;
        }

        .set-validation-icon.invalid {
            color: #ef4444;
        }

        .set-validation-icon.partial {
            color: #f59e0b;
        }

        /* Enhanced drag feedback */
        .drag-preview {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            background: white;
            border: 2px solid #3b82f6;
            border-radius: 0.5rem;
            padding: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            transform: rotate(-5deg);
        }

        .drop-zone-highlight {
            animation: pulseBlue 1s ease-in-out infinite;
        }

        @keyframes pulseBlue {
            0%, 100% { border-color: #3b82f6; }
            50% { border-color: #1d4ed8; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-hard-hat text-3xl mr-4 text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Quản lý Câu hỏi Hội thi</h1>
                        <p class="text-gray-600">An Toàn Vệ Sinh Viên Giỏi 2025</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">                    <div class="flex items-center">
                        <span class="text-sm text-gray-500 mr-2">Phím tắt:</span>
                        <div class="text-xs text-gray-400 space-x-2">
                            <span>Ctrl+S: Lưu</span>
                            <span>Ctrl+N: Tạo mới</span>
                            <span>Ctrl+L: Tải dữ liệu</span>
                            <span>Ctrl+E: Xuất</span>
                            <span>Ctrl+1/2: Chuyển tab</span>
                        </div>
                    </div>
                    <button id="loadDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg smooth-transition">
                        <i class="fas fa-upload mr-2"></i>Tải dữ liệu
                    </button>
                    <button id="exportAllBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg smooth-transition">
                        <i class="fas fa-download mr-2"></i>Xuất tất cả
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <nav class="flex space-x-8">
                <button class="tab-button active px-4 py-3 text-blue-600 font-medium" data-tab="edit">
                    <i class="fas fa-edit mr-2"></i>Chỉnh sửa câu hỏi
                </button>
                <button class="tab-button px-4 py-3 text-gray-600 font-medium hover:text-blue-600" data-tab="compose">
                    <i class="fas fa-layer-group mr-2"></i>Tạo bộ câu hỏi
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">        <!-- Tab 1: Edit Questions -->
        <div id="editTab" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Questions List -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-800">
                                    <i class="fas fa-list mr-2"></i>Danh sách Câu hỏi
                                </h2>
                                <div class="flex items-center space-x-4">
                                    <!-- Filter -->
                                    <div class="flex items-center space-x-2">
                                        <select id="filterCategory" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                            <option value="">Tất cả danh mục</option>
                                            <option value="CSPL">Chính sách pháp luật</option>
                                            <option value="PCCC">Phòng cháy chữa cháy</option>
                                            <option value="BV">Bảo vệ</option>
                                            <option value="KTM">Khai thác mỏ</option>
                                            <option value="BXVC">Bốc xếp vận chuyển</option>
                                            <option value="YT">Y tế</option>
                                        </select>
                                        <select id="filterRound" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                            <option value="">Tất cả vòng</option>
                                            <option value="1">Vòng 1</option>
                                            <option value="2">Vòng 2</option>
                                            <option value="3">Vòng 3</option>
                                        </select>
                                    </div>
                                    <!-- Search -->
                                    <div class="relative">
                                        <input type="text" id="searchQuestions" placeholder="Tìm kiếm câu hỏi..." 
                                               class="border border-gray-300 rounded-lg px-3 py-1 pl-8 text-sm w-64">
                                        <i class="fas fa-search absolute left-3 top-2 text-gray-400 text-sm"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div id="questionsList" class="space-y-4">
                                <!-- Questions will be displayed here -->
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-question-circle text-4xl mb-4 opacity-50"></i>
                                    <p>Chưa có câu hỏi nào. Hãy thêm câu hỏi đầu tiên!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <span id="formTitle">Thêm câu hỏi mới</span>
                            </h2>
                        </div>
                        
                        <div class="p-6">
                            <form id="questionForm">
                                <!-- ID và Loại câu hỏi -->
                                <div class="grid grid-cols-1 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-tag mr-1"></i>ID Câu hỏi:
                                        </label>
                                        <input type="text" id="questionId" 
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="VD: CSPL_TN_1" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-list mr-1"></i>Loại câu hỏi:
                                        </label>
                                        <select id="questionType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="Trắc nghiệm">Trắc nghiệm</option>
                                            <option value="Thực hành">Thực hành</option>
                                            <option value="Lý thuyết tự luận">Lý thuyết tự luận</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Nội dung câu hỏi -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-question-circle mr-1"></i>Nội dung câu hỏi:
                                    </label>
                                    <textarea id="questionContent" rows="3" 
                                              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                              placeholder="Nhập nội dung câu hỏi..." required></textarea>
                                </div>
                                  <!-- Phương án trả lời -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-list-ul mr-1"></i>Các phương án trả lời:
                                    </label>
                                    <div class="space-y-2" id="optionsContainer">
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium">A</span>
                                            <input type="text" id="optionA" placeholder="Phương án A" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-medium">B</span>
                                            <input type="text" id="optionB" placeholder="Phương án B" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center text-sm font-medium">C</span>
                                            <input type="text" id="optionC" placeholder="Phương án C" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-medium">D</span>
                                            <input type="text" id="optionD" placeholder="Phương án D" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2" style="display: none;">
                                            <span class="w-6 h-6 bg-purple-500 text-white rounded-full flex items-center justify-center text-sm font-medium">E</span>
                                            <input type="text" id="optionE" placeholder="Phương án E" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2" style="display: none;">
                                            <span class="w-6 h-6 bg-pink-500 text-white rounded-full flex items-center justify-center text-sm font-medium">F</span>
                                            <input type="text" id="optionF" placeholder="Phương án F" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2" style="display: none;">
                                            <span class="w-6 h-6 bg-indigo-500 text-white rounded-full flex items-center justify-center text-sm font-medium">G</span>
                                            <input type="text" id="optionG" placeholder="Phương án G" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2" style="display: none;">
                                            <span class="w-6 h-6 bg-gray-500 text-white rounded-full flex items-center justify-center text-sm font-medium">H</span>
                                            <input type="text" id="optionH" placeholder="Phương án H" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                    <button type="button" id="addOptionBtn" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-plus mr-1"></i>Thêm phương án
                                    </button>
                                </div>
                                  <!-- Cài đặt câu hỏi -->
                                <div class="grid grid-cols-1 gap-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-check-circle mr-1"></i>Đáp án đúng:
                                        </label>
                                        <input type="text" id="correctAnswer" 
                                               placeholder="VD: A hoặc A,B,C hoặc A, B, C" 
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <p class="text-xs text-gray-500 mt-1">Nhập một hoặc nhiều đáp án đúng, cách nhau bằng dấu phẩy</p>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-folder mr-1"></i>Danh mục:
                                        </label>
                                        <select id="category" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="CSPL">Chính sách pháp luật</option>
                                            <option value="PCCC">Phòng cháy chữa cháy</option>
                                            <option value="BV">Bảo vệ</option>
                                            <option value="KTM">Khai thác mỏ</option>
                                            <option value="BXVC">Bốc xếp vận chuyển</option>
                                            <option value="YT">Y tế</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-layer-group mr-1"></i>Vòng thi:
                                        </label>
                                        <select id="round" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="1">Vòng 1</option>
                                            <option value="2">Vòng 2</option>
                                            <option value="3">Vòng 3</option>
                                        </select>
                                    </div>
                                </div>
                                  <!-- Tùy chọn bổ sung -->
                                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fas fa-cog mr-1"></i>Tùy chọn bổ sung:
                                    </h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="useImage" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <label for="useImage" class="ml-2 text-sm text-gray-700">Có hình ảnh minh họa</label>
                                        </div>
                                        <div id="imageIdSection" class="hidden space-y-2">
                                            <input type="text" id="imageId" placeholder="Đường dẫn hình ảnh (VD: images/cauhoi/ktm_image_1.jpeg)" 
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <input type="text" id="bgImage" placeholder="Hình nền (VD: images/bg/bg1.jpg)" 
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <select id="positionImage" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                                <option value="Right">Vị trí hình ảnh: Bên phải</option>
                                                <option value="Left">Vị trí hình ảnh: Bên trái</option>
                                                <option value="Top">Vị trí hình ảnh: Trên</option>
                                                <option value="Bottom">Vị trí hình ảnh: Dưới</option>
                                            </select>
                                        </div>
                                        
                                        <div class="flex items-center">
                                            <input type="checkbox" id="questionImage" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <label for="questionImage" class="ml-2 text-sm text-gray-700">Câu hỏi hình ảnh (question_image)</label>
                                        </div>
                                        
                                        <div class="border-t pt-3 mt-3">
                                            <h4 class="text-sm font-medium text-gray-700 mb-2">File âm thanh:</h4>
                                            <div class="space-y-2">
                                                <input type="text" id="speechIdQuestion" placeholder="Âm thanh câu hỏi (VD: V2_KTM_HA_1.wav)" 
                                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <input type="text" id="speechIdAnswer" placeholder="Âm thanh đáp án (VD: V2_KTM_HA_1_ans.wav)" 
                                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                <div id="speechOptionsContainer" class="space-y-1">
                                                    <input type="text" id="speechIdA" placeholder="Âm thanh phương án A" 
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdB" placeholder="Âm thanh phương án B" 
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdC" placeholder="Âm thanh phương án C" 
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdD" placeholder="Âm thanh phương án D" 
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdE" placeholder="Âm thanh phương án E" style="display: none;"
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdF" placeholder="Âm thanh phương án F" style="display: none;"
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdG" placeholder="Âm thanh phương án G" style="display: none;"
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                    <input type="text" id="speechIdH" placeholder="Âm thanh phương án H" style="display: none;"
                                                           class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Buttons -->
                                <div class="flex space-x-3">
                                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg smooth-transition">
                                        <i class="fas fa-save mr-2"></i>
                                        <span id="submitBtnText">Lưu câu hỏi</span>
                                    </button>
                                    <button type="button" id="clearForm" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg smooth-transition">
                                        <i class="fas fa-times mr-2"></i>Hủy
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>                </div>
            </div>
        </div>

        <!-- Tab 2: Compose Question Sets -->
        <div id="composeTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Available Questions -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-database mr-2"></i>Câu hỏi có sẵn
                            </h2>
                        </div>
                        
                        <div class="p-4">
                            <!-- Quick filters -->
                            <div class="space-y-2 mb-4">
                                <select id="composeFilterRound" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">Tất cả vòng</option>
                                    <option value="1">Vòng 1</option>
                                    <option value="2">Vòng 2</option>
                                    <option value="3">Vòng 3</option>
                                </select>                                <select id="composeFilterCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">Tất cả danh mục</option>
                                    <option value="CSPL">Chính sách pháp luật</option>
                                    <option value="PCCC">Phòng cháy chữa cháy</option>
                                    <option value="BV">Bảo vệ</option>
                                    <option value="KTM">Khai thác mỏ</option>
                                    <option value="BXVC">Bốc xếp vận chuyển</option>
                                    <option value="YT">Y tế</option>
                                </select>
                                <input type="text" id="composeSearch" placeholder="Tìm kiếm..." 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            </div>
                            
                            <div id="availableQuestions" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Available questions will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Set Builder -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-800">
                                    <i class="fas fa-layer-group mr-2"></i>Tạo bộ câu hỏi
                                </h2>                                <div class="flex space-x-2">
                                    <button id="exportRoundData" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg smooth-transition">
                                        <i class="fas fa-download mr-2"></i>Xuất dữ liệu vòng
                                    </button>
                                    <button id="saveQuestionSet" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg smooth-transition">
                                        <i class="fas fa-save mr-2"></i>Lưu bộ đề
                                    </button>
                                    <button id="clearQuestionSet" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg smooth-transition">
                                        <i class="fas fa-trash mr-2"></i>Xóa tất cả
                                    </button>
                                </div>
                            </div>
                        </div>                        <div class="p-6">
                            <!-- Round Selection Tabs -->
                            <div class="mb-6">
                                <div class="border-b border-gray-200">
                                    <nav class="-mb-px flex space-x-8">
                                        <button class="round-tab-button py-2 px-1 border-b-2 font-medium text-sm" data-round="1">
                                            <i class="fas fa-trophy mr-2"></i>Vòng 1
                                        </button>
                                        <button class="round-tab-button py-2 px-1 border-b-2 font-medium text-sm" data-round="2">
                                            <i class="fas fa-medal mr-2"></i>Vòng 2
                                        </button>
                                        <button class="round-tab-button py-2 px-1 border-b-2 font-medium text-sm" data-round="3">
                                            <i class="fas fa-crown mr-2"></i>Vòng 3
                                        </button>
                                    </nav>
                                </div>
                            </div>

                            <!-- Round Content Containers -->
                            
                            <!-- Vòng 1 Content -->
                            <div id="round1-content" class="round-content">
                                <!-- Progress Indicator for Round 1 -->
                                <div class="progress-indicator">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-trophy text-blue-600"></i>
                                        <span class="font-medium text-gray-700">Tiến độ Vòng 1:</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="round1-progress-fill" class="progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="question-counter">
                                        <span class="counter-badge" id="round1-counter">0</span>
                                        <span>câu hỏi đã chọn</span>
                                    </div>
                                </div>
                                
                                <!-- Validation Message -->
                                <div id="round1-validation" class="validation-message">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <span id="round1-validation-text"></span>
                                </div>
                                
                                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-blue-800 mb-2">
                                        <i class="fas fa-trophy mr-2"></i>Vòng 1 - Thi Trắc nghiệm
                                    </h3>
                                    <p class="text-sm text-blue-600">Kéo thả câu hỏi vào khu vực bên dưới để tạo bộ đề cho Vòng 1</p>
                                </div>
                                
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <!-- Available Questions for Round 1 -->
                                    <div class="bg-white border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b">
                                            <h4 class="font-medium text-gray-800">Câu hỏi có sẵn (Vòng 1)</h4>
                                        </div>
                                        <div id="round1-available" class="p-4 max-h-96 overflow-y-auto">
                                            <!-- Questions will be loaded here -->
                                        </div>
                                    </div>
                                    
                                    <!-- Round 1 Question Set -->
                                    <div class="bg-white border-2 border-dashed border-blue-300 rounded-lg drop-zone" data-round="1">
                                        <div class="px-4 py-3 bg-blue-50 border-b">
                                            <h4 class="font-medium text-blue-800">Bộ đề Vòng 1</h4>
                                        </div>
                                        <div id="round1Questions" class="p-4 min-h-64">
                                            <p class="text-center text-gray-500 text-sm">Kéo thả câu hỏi vào đây</p>
                                        </div>
                                    </div>
                                </div>
                            </div>                            <!-- Vòng 2 Content -->
                            <div id="round2-content" class="round-content hidden">
                                <!-- Progress Indicator for Round 2 -->
                                <div class="progress-indicator">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-medal text-green-600"></i>
                                        <span class="font-medium text-gray-700">Tiến độ Vòng 2:</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="round2-progress-fill" class="progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="question-counter">
                                        <span class="counter-badge" id="round2-counter">0/63</span>
                                        <span>câu hỏi đã phân bổ</span>
                                    </div>
                                </div>
                                
                                <!-- Validation Message -->
                                <div id="round2-validation" class="validation-message">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <span id="round2-validation-text"></span>
                                </div>
                                
                                <div class="bg-green-50 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-green-800 mb-2">
                                        <i class="fas fa-medal mr-2"></i>Vòng 2 - Thi Lý thuyết chuyên môn
                                    </h3>
                                    <p class="text-sm text-green-600">Mỗi lĩnh vực có nhiều bộ đề, mỗi bộ đề có 3 câu (2 hình ảnh + 1 thường)</p>
                                </div>

                                <!-- Available Questions for Round 2 -->
                                <div class="mb-6">
                                    <div class="bg-white border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b">
                                            <h4 class="font-medium text-gray-800">Câu hỏi có sẵn (Vòng 2)</h4>
                                            <p class="text-sm text-gray-600">Kéo thả vào các bộ đề bên dưới</p>
                                        </div>
                                        <div id="round2-available" class="p-4 max-h-64 overflow-y-auto">
                                            <!-- Round 2 questions will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Round 2 Categories -->
                                <div class="space-y-6">
                                    <!-- BXVC Category -->
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
                                            <h4 class="font-medium text-gray-800">LÝ THUYẾT BẢO QUẢN, BỐC XẾP, VẬN CHUYỂN VLNCN</h4>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm text-gray-600">Số bộ đề:</span>
                                                <input type="number" id="bxvc-sets" value="5" min="1" max="20" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                <button onclick="updateRound2Sets('bxvc')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Cập nhật</button>
                                            </div>
                                        </div>
                                        <div id="bxvc-container" class="p-4">
                                            <!-- BXVC question sets will be generated here -->
                                        </div>
                                    </div>

                                    <!-- BV Category -->
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
                                            <h4 class="font-medium text-gray-800">LÝ THUYẾT BẢO VỆ</h4>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm text-gray-600">Số bộ đề:</span>
                                                <input type="number" id="bv-sets" value="8" min="1" max="20" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                <button onclick="updateRound2Sets('bv')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Cập nhật</button>
                                            </div>
                                        </div>
                                        <div id="bv-container" class="p-4">
                                            <!-- BV question sets will be generated here -->
                                        </div>
                                    </div>

                                    <!-- KTM Category -->
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
                                            <h4 class="font-medium text-gray-800">LÝ THUYẾT KHAI THÁC MỎ</h4>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm text-gray-600">Số bộ đề:</span>
                                                <input type="number" id="ktm-sets" value="8" min="1" max="20" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                <button onclick="updateRound2Sets('ktm')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Cập nhật</button>
                                            </div>
                                        </div>
                                        <div id="ktm-container" class="p-4">
                                            <!-- KTM question sets will be generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Vòng 3 Content -->
                            <div id="round3-content" class="round-content hidden">
                                <!-- Progress Indicator for Round 3 -->
                                <div class="progress-indicator">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-crown text-yellow-600"></i>
                                        <span class="font-medium text-gray-700">Tiến độ Vòng 3:</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="round3-progress-fill" class="progress-fill" style="width: 0%"></div>
                                    </div>
                                    <div class="question-counter">
                                        <span class="counter-badge" id="round3-counter">0/17</span>
                                        <span>câu hỏi đã phân bổ</span>
                                    </div>
                                </div>
                                
<<<<<<< HEAD
                                <!-- Validation Message -->
                                <div id="round3-validation" class="validation-message">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    <span id="round3-validation-text"></span>
                                </div>
                                
                                <div class="bg-yellow-50 rounded-lg p-4 mb-4">
                                    <h3 class="text-lg font-semibold text-yellow-800 mb-2">
                                        <i class="fas fa-crown mr-2"></i>Vòng 3 - Thi Thực hành
                                    </h3>
                                    <p class="text-sm text-yellow-600">Mỗi đề là một câu thực hành từ ngân hàng câu hỏi</p>
                                </div>

                                <!-- Available Questions for Round 3 -->
                                <div class="mb-6">
                                    <div class="bg-white border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b">
                                            <h4 class="font-medium text-gray-800">Câu hỏi có sẵn (Vòng 3)</h4>
                                            <p class="text-sm text-gray-600">Kéo thả vào các bộ đề bên dưới</p>
                                        </div>
                                        <div id="round3-available" class="p-4 max-h-64 overflow-y-auto">
                                            <!-- Round 3 questions will be loaded here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Round 3 Categories -->
                                <div class="space-y-6">
                                    <!-- Y Tế Category -->
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
                                            <h4 class="font-medium text-gray-800">THỰC HÀNH Y TẾ</h4>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm text-gray-600">Số đề:</span>
                                                <input type="number" id="yt-sets" value="6" min="1" max="20" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                <button onclick="updateRound3Sets('yt')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Cập nhật</button>
                                            </div>
                                        </div>
                                        <div id="yt-container" class="p-4">
                                            <!-- Y Tế question sets will be generated here -->
                                        </div>
                                    </div>

                                    <!-- PCCC Category -->
                                    <div class="border border-gray-200 rounded-lg">
                                        <div class="px-4 py-3 bg-gray-50 border-b flex justify-between items-center">
                                            <h4 class="font-medium text-gray-800">THỰC HÀNH PHÒNG CHÁY CHỮA CHÁY</h4>
                                            <div class="flex items-center space-x-2">
                                                <span class="text-sm text-gray-600">Số đề:</span>
                                                <input type="number" id="pccc-sets" value="11" min="1" max="20" class="w-16 px-2 py-1 border border-gray-300 rounded text-sm">
                                                <button onclick="updateRound3Sets('pccc')" class="bg-blue-500 text-white px-2 py-1 rounded text-xs">Cập nhật</button>
                                            </div>
                                        </div>
                                        <div id="pccc-container" class="p-4">
                                            <!-- PCCC question sets will be generated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                                    </div>
=======
                                <!-- Vòng 2 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                    <h3 class="text-lg font-semibold text-center mb-4 text-green-600">
                                        <i class="fas fa-medal mr-2"></i>Vòng 2
                                    </h3>
                                    <div id="round2Container"></div>
                                </div>
                                
                                <!-- Vòng 3 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                    <h3 class="text-lg font-semibold text-center mb-4 text-yellow-600">
                                        <i class="fas fa-crown mr-2"></i>Vòng 3
                                    </h3>
                                    <div id="round3Questions"></div>
>>>>>>> v2
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="toastMessage">Thành công!</span>
            </div>
        </div>
    </div>

    <!-- File Input (Hidden) -->
    <input type="file" id="fileInput" accept=".json" multiple style="display: none;">

    <script>
        // Global variables
        let questions = [];
        // Global variable for saved sets
let questionSets = {};

        // Categories mapping
        const categoryLabels = {
            'CSPL': 'Chính sách pháp luật',
            'PCCC': 'Phòng cháy chữa cháy',
            'BV': 'Bảo vệ',
            'KTM': 'Khai thác mỏ',
            'BXVC': 'Bốc xếp vận chuyển',
            'YT': 'Y tế'
        };

        const categoryColors = {
            'CSPL': 'bg-blue-100 text-blue-800',
            'PCCC': 'bg-red-100 text-red-800',
            'BV': 'bg-green-100 text-green-800',
            'KTM': 'bg-yellow-100 text-yellow-800',
            'BXVC': 'bg-purple-100 text-purple-800',
            'YT': 'bg-pink-100 text-pink-800'
        };        // Initialize the application
        function init() {
            console.log('=== Application Initialization Started ===');
            console.log('DOM ready state:', document.readyState);
            console.log('User agent:', navigator.userAgent);
            
            try {
                setupEventListeners();
                console.log('✓ Event listeners setup completed');
                
                initializeDragAndDrop();
                console.log('✓ Drag and drop initialized');
                
                setupKeyboardShortcuts();
                console.log('✓ Keyboard shortcuts initialized');
                
                loadQuestions();
                console.log('✓ Questions loaded from localStorage');
                
                updateTotalCount();
                console.log('✓ Total count updated');
                
                // Trigger initial form state setup
                handleQuestionTypeChange();
                console.log('✓ Initial form state setup completed');
                  // Initialize compose tab
                filterAvailableQuestions();
                displayQuestionSets();
                console.log('✓ Compose tab initialized');
                
<<<<<<< HEAD
                // Initialize round tabs and content
                initRoundTabs();
                console.log('✓ Round tabs initialized');
=======
                // Load question sets from JSON file
                loadQuestionSets();
                console.log('✓ Question sets loaded');
>>>>>>> v2
                
                // Run test function for debugging
                testFileLoading();
                
                console.log('=== Application initialized successfully ===');
            } catch (error) {
                console.error('❌ Error during initialization:', error);
                showToast('Lỗi khởi tạo ứng dụng!', 'error');
            }
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+S: Save current form
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    const form = document.getElementById('questionForm');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                    return;
                }
                
                // Ctrl+N: Clear form (New question)
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    clearForm();
                    document.getElementById('questionId').focus();
                    return;
                }
                
                // Ctrl+L: Focus on file load
                if (e.ctrlKey && e.key === 'l') {
                    e.preventDefault();
                    document.getElementById('loadDataBtn').click();
                    return;
                }
                
                // Ctrl+E: Export all
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportToJSON();
                    return;
                }
                
                // Tab navigation: Ctrl+1, Ctrl+2
                if (e.ctrlKey && e.key === '1') {
                    e.preventDefault();
                    switchTab('edit');
                    return;
                }
                
                if (e.ctrlKey && e.key === '2') {
                    e.preventDefault();
                    switchTab('compose');
                    return;
                }
                
                // Escape: Clear form or close dialogs
                if (e.key === 'Escape') {
                    clearForm();
                    return;
                }
            });
            
            console.log('Keyboard shortcuts setup completed');
        }

        // Test function to verify file loading (for debugging)
        function testFileLoading() {
            console.log('=== Testing File Loading ===');
            console.log('Load data button:', document.getElementById('loadDataBtn'));
            console.log('File input:', document.getElementById('fileInput'));
            console.log('Current questions count:', questions.length);
            console.log('Event listeners check completed');
        }

        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });            // Form submission
            const questionForm = document.getElementById('questionForm');
            const clearFormBtn = document.getElementById('clearForm');
            const useImage = document.getElementById('useImage');
            const questionType = document.getElementById('questionType');
            
            if (questionForm) {
                questionForm.addEventListener('submit', handleFormSubmit);
                console.log('Question form event listener added');
            } else {
                console.error('Question form not found');
            }
            
            if (clearFormBtn) {
                clearFormBtn.addEventListener('click', clearForm);
                console.log('Clear form event listener added');
            } else {
                console.error('Clear form button not found');
            }
            
            if (useImage) {
                useImage.addEventListener('change', toggleImageSection);
                console.log('Use image event listener added');
            } else {
                console.error('Use image checkbox not found');
            }
            
            if (questionType) {
                questionType.addEventListener('change', handleQuestionTypeChange);
                console.log('Question type event listener added');
            } else {
                console.error('Question type select not found');
            }

            // Filter and search
            const filterCategory = document.getElementById('filterCategory');
            const filterRound = document.getElementById('filterRound');
            const searchQuestions = document.getElementById('searchQuestions');
            
            if (filterCategory) {
                filterCategory.addEventListener('change', filterAndDisplayQuestions);
                console.log('Filter category event listener added');
            }
            if (filterRound) {
                filterRound.addEventListener('change', filterAndDisplayQuestions);
                console.log('Filter round event listener added');
            }
            if (searchQuestions) {
                searchQuestions.addEventListener('input', filterAndDisplayQuestions);
                console.log('Search questions event listener added');
            }

            // Compose tab filters
            const composeFilterRound = document.getElementById('composeFilterRound');
            const composeFilterCategory = document.getElementById('composeFilterCategory');
            const composeSearch = document.getElementById('composeSearch');
            
            if (composeFilterRound) {
                composeFilterRound.addEventListener('change', filterAvailableQuestions);
                console.log('Compose filter round event listener added');
            }
            if (composeFilterCategory) {
                composeFilterCategory.addEventListener('change', filterAvailableQuestions);
                console.log('Compose filter category event listener added');
            }
            if (composeSearch) {
                composeSearch.addEventListener('input', filterAvailableQuestions);
                console.log('Compose search event listener added');
            }            // File operations
            const loadDataBtn = document.getElementById('loadDataBtn');
            const fileInput = document.getElementById('fileInput');
            const exportAllBtn = document.getElementById('exportAllBtn');
            
            if (loadDataBtn) {
                loadDataBtn.addEventListener('click', () => {
                    console.log('Load data button clicked');
                    const fileInput = document.getElementById('fileInput');
                    if (fileInput) {
                        console.log('Triggering file input click');
                        fileInput.click();
                    } else {
                        console.error('File input not found when load button clicked');
                    }
                });
                console.log('Load data button event listener added');
            } else {
                console.error('Load data button not found');
            }
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileLoad);
                console.log('File input event listener added');
            } else {
                console.error('File input not found');
            }
            
            if (exportAllBtn) {
                exportAllBtn.addEventListener('click', exportToJSON);
                console.log('Export all button event listener added');
            } else {
                console.error('Export all button not found');
            }            // Question set operations
            const saveQuestionSetBtn = document.getElementById('saveQuestionSet');
            const clearQuestionSetBtn = document.getElementById('clearQuestionSet');
              if (saveQuestionSetBtn) {
                saveQuestionSetBtn.addEventListener('click', saveQuestionSet);
                console.log('Save question set event listener added');
            }
            if (clearQuestionSetBtn) {
                clearQuestionSetBtn.addEventListener('click', clearQuestionSet);
                console.log('Clear question set event listener added');
            }
            
            // Export round data button
            const exportRoundDataBtn = document.getElementById('exportRoundData');
            if (exportRoundDataBtn) {
                exportRoundDataBtn.addEventListener('click', exportRoundData);
                console.log('Export round data event listener added');
            }

            // Add option button
            const addOptionBtn = document.getElementById('addOptionBtn');
            if (addOptionBtn) {
                addOptionBtn.addEventListener('click', addOption);
                console.log('Add option button event listener added');
            } else {
                console.error('Add option button not found');
            }            // Setup drag and drop
            setupDragAndDrop();
            
            console.log('Event listeners setup completed');
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'text-blue-600');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName === 'edit' ? 'editTab' : 'composeTab').classList.add('active');

            // Refresh compose tab content if switching to it
            if (tabName === 'compose') {
                filterAvailableQuestions();
                displayQuestionSets();
            }
        }

        // Load questions from localStorage
        function loadQuestions() {
            const saved = localStorage.getItem('hoi_thi_questions');
            if (saved) {
                questions = JSON.parse(saved);
                filterAndDisplayQuestions();
                updateTotalCount();
            }
        }

        // Save questions to localStorage
        function saveQuestions() {
            localStorage.setItem('hoi_thi_questions', JSON.stringify(questions));
            updateTotalCount();
        }

        // Load saved sets from JSON file
        function loadQuestionSets() {
  fetch('question_sets.json')
    .then(res => res.json())
    .then(data => {
      questionSets = data;
      renderSavedSets();
    })
    .catch(err => console.error('Failed to load question sets:', err));
}

// Render saved sets UI
function renderSavedSets() {
  const container = document.getElementById('questionSetsList');
  container.innerHTML = '';
  // Vòng 1
  if (questionSets.vong1) {
    Object.entries(questionSets.vong1).forEach(([idx, ids]) => {
      const div = document.createElement('div');
      div.className = 'p-2 border rounded mb-2';
      const items = ids.map(id => {
        const q = questions.find(q => q.id === id);
        return q ? `<li><strong>${q.id}</strong>: ${q.cau_hoi}</li>` : `<li>${id} (chưa tải)</li>`;
      }).join('');
      div.innerHTML = `<strong>Vòng 1 - Bộ ${idx}:</strong><ul>${items}</ul>`;
      container.appendChild(div);
    });
  }
  // Vòng 2
  if (questionSets.vong2) {
    Object.entries(questionSets.vong2).forEach(([domain, sets]) => {
      Object.entries(sets).forEach(([idx, ids]) => {
        const div = document.createElement('div');
        div.className = 'p-2 border rounded mb-2';
        const items = ids.map(id => {
          const q = questions.find(q => q.id === id);
          return q ? `<li><strong>${q.id}</strong>: ${q.cau_hoi}</li>` : `<li>${id} (chưa tải)</li>`;
        }).join('');
        div.innerHTML = `<strong>Vòng 2 - ${domain} - Bộ ${idx}:</strong><ul>${items}</ul>`;
        container.appendChild(div);
      });
    });
  }
  // Vòng 3
  if (questionSets.vong3) {
    Object.entries(questionSets.vong3).forEach(([idx, ids]) => {
      const div = document.createElement('div');
      div.className = 'p-2 border rounded mb-2';
      const items = ids.map(id => {
        const q = questions.find(q => q.id === id);
        return q ? `<li><strong>${q.id}</strong>: ${q.cau_hoi}</li>` : `<li>${id} (chưa tải)</li>`;
      }).join('');
      div.innerHTML = `<strong>Vòng 3 - Đề ${idx}:</strong><ul>${items}</ul>`;
      container.appendChild(div);
    });
  }
}

        // Update total questions count
        function updateTotalCount() {
<<<<<<< HEAD
            const totalElement = document.getElementById('totalQuestions');
            if (totalElement) {
                totalElement.textContent = questions.length;
            }
        }

        // Handle file loading
        function handleFileLoad(event) {
            console.log('File load event triggered');
            const files = event.target.files;
            
            if (files.length === 0) {
                console.log('No files selected');
                return;
            }
            
            // Process each selected file
            Array.from(files).forEach((file, index) => {
                console.log(`Processing file ${index + 1}:`, file.name);
                
                if (!file.name.endsWith('.json')) {
                    showToast(`File ${file.name} không phải là file JSON!`, 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        console.log('JSON data loaded:', jsonData);
                        
                        // Handle different JSON structures
                        let newQuestions = [];
                        
                        if (Array.isArray(jsonData)) {
                            // Direct array of questions
                            newQuestions = jsonData;
                        } else if (jsonData.questions && Array.isArray(jsonData.questions)) {
                            // Questions wrapped in an object
                            newQuestions = jsonData.questions;
                        } else if (jsonData.vong_1 || jsonData.vong_2 || jsonData.vong_3) {
                            // Round-based structure
                            Object.keys(jsonData).forEach(round => {
                                const roundData = jsonData[round];
                                if (Array.isArray(roundData)) {
                                    newQuestions = newQuestions.concat(roundData);
                                } else if (typeof roundData === 'object') {
                                    Object.keys(roundData).forEach(category => {
                                        const categoryData = roundData[category];
                                        if (Array.isArray(categoryData)) {
                                            newQuestions = newQuestions.concat(categoryData);
                                        }
                                    });
                                }
                            });
                        } else {
                            // Try to find questions in any property
                            Object.keys(jsonData).forEach(key => {
                                const value = jsonData[key];
                                if (Array.isArray(value) && value.length > 0 && value[0].cau_hoi) {
                                    newQuestions = newQuestions.concat(value);
                                }
                            });
                        }
                        
                        if (newQuestions.length === 0) {
                            showToast(`Không tìm thấy câu hỏi trong file ${file.name}!`, 'error');
                            return;
                        }
                        
                        // Validate and add questions
                        let addedCount = 0;
                        let skippedCount = 0;
                        
                        newQuestions.forEach(question => {
                            // Basic validation
                            if (question.id && question.cau_hoi) {
                                // Check for duplicates
                                const existingIndex = questions.findIndex(q => q.id === question.id);
                                if (existingIndex === -1) {
                                    questions.push(question);
                                    addedCount++;
                                } else {
                                    // Replace existing question
                                    questions[existingIndex] = question;
                                    skippedCount++;
                                }
                            } else {
                                skippedCount++;
                            }
                        });
                        
                        saveQuestions();
                        filterAndDisplayQuestions();
                        
                        showToast(`Đã tải ${addedCount} câu hỏi từ ${file.name}! ${skippedCount > 0 ? `(Bỏ qua ${skippedCount} câu)` : ''}`, 'success');
                        
                    } catch (error) {
                        console.error('Error parsing JSON:', error);
                        showToast(`Lỗi đọc file ${file.name}: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast(`Lỗi đọc file ${file.name}!`, 'error');
                };
                
                reader.readAsText(file);
            });
            
            // Clear the file input
            event.target.value = '';
        }

        // Export questions to JSON
        function exportToJSON() {
            try {
                if (questions.length === 0) {
                    showToast('Không có câu hỏi nào để xuất!', 'error');
                    return;
                }
                
                const exportData = {
                    metadata: {
                        title: 'Ngân hàng câu hỏi Hội thi An toàn Vệ sinh Viên Giỏi 2025',
                        exportDate: new Date().toISOString(),
                        totalQuestions: questions.length,
                        version: '1.0'
                    },
                    questions: questions
                };
                
                const dataBlob = new Blob([JSON.stringify(exportData, null, 2)], { 
                    type: 'application/json' 
                });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `questions_export_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast(`Đã xuất ${questions.length} câu hỏi thành công!`, 'success');
                
            } catch (error) {
                console.error('Export error:', error);
                showToast('Lỗi khi xuất dữ liệu!', 'error');
            }
=======
            const countEl = document.getElementById('totalQuestions');
            if (!countEl) return;
            countEl.textContent = questions.length;
>>>>>>> v2
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            // Create toast element if it doesn't exist
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300';
                toast.innerHTML = `
                    <div class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg">
                        <span id="toastMessage"></span>
                    </div>
                `;
                document.body.appendChild(toast);
            }
            
            const toastMessage = document.getElementById('toastMessage');
            const toastDiv = toast.firstElementChild;
            
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toastDiv.className = 'bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg';
            } else if (type === 'error') {
                toastDiv.className = 'bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg';
            } else if (type === 'warning') {
                toastDiv.className = 'bg-yellow-600 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // Delete question
        function deleteQuestion(index) {
            if (confirm('Bạn có chắc chắn muốn xóa câu hỏi này không?')) {
                questions.splice(index, 1);
                saveQuestions();
                filterAndDisplayQuestions();
                showToast('Đã xóa câu hỏi thành công!', 'success');
            }
        }

        // Add option functionality
        function addOption() {
            const options = ['optionE', 'optionF', 'optionG', 'optionH'];
            const speechOptions = ['speechIdE', 'speechIdF', 'speechIdG', 'speechIdH'];
            
            for (let i = 0; i < options.length; i++) {
                const optionElement = document.getElementById(options[i]);
                const speechElement = document.getElementById(speechOptions[i]);
                
                if (optionElement && optionElement.parentElement.style.display === 'none') {
                    optionElement.parentElement.style.display = 'flex';
                    speechElement.style.display = 'block';
                    
                    // Hide add button if all options are shown
                    if (i === options.length - 1) {
                        document.getElementById('addOptionBtn').style.display = 'none';
                    }
                    break;
                }
            }
        }

        // Update options display based on available data
        function updateOptionsDisplay(phuongAn) {
            const allOptions = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            let lastVisibleIndex = 3; // D is always visible initially
            
            // Find the last option that has data
            allOptions.forEach((letter, index) => {
                if (phuongAn[letter.toLowerCase()]) {
                    lastVisibleIndex = index;
                }
            });
            
            // Show options up to the last one with data
            allOptions.forEach((letter, index) => {
                const optionElement = document.getElementById(`option${letter}`);
                const speechElement = document.getElementById(`speechId${letter}`);
                
                if (optionElement) {
                    if (index <= lastVisibleIndex || index < 4) { // Always show A-D
                        optionElement.parentElement.style.display = 'flex';
                        if (speechElement) speechElement.style.display = 'block';
                    } else {
                        optionElement.parentElement.style.display = 'none';
                        if (speechElement) speechElement.style.display = 'none';
                    }
                }
            });
            
            // Hide add button if all options are shown
            const addOptionBtn = document.getElementById('addOptionBtn');
            if (addOptionBtn) {
                addOptionBtn.style.display = lastVisibleIndex >= 7 ? 'none' : 'block';
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');
            init();
        });

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const question = {
                id: document.getElementById('questionId').value.trim(),
                cau_hoi: document.getElementById('questionContent').value.trim(),
                type_question: document.getElementById('questionType').value,
                category: document.getElementById('category').value,
                round: document.getElementById('round').value,
                phuong_an: {},
                dap_an_dung: document.getElementById('correctAnswer').value.trim(),
                use_image: document.getElementById('useImage').checked ? 'Yes' : 'No',
                image_id: document.getElementById('imageId').value.trim(),
                question_image: document.getElementById('questionImage').checked ? 'Yes' : 'No',
                position_image: document.getElementById('positionImage').value,
                bg_image: document.getElementById('bgImage').value.trim(),
                speech_id_question: document.getElementById('speechIdQuestion').value.trim(),
                speech_id_answer: document.getElementById('speechIdAnswer').value.trim()
            };

            // Add non-empty options (A-H)
            const options = ['optionA', 'optionB', 'optionC', 'optionD', 'optionE', 'optionF', 'optionG', 'optionH'];
            const optionKeys = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
            const speechOptions = ['speechIdA', 'speechIdB', 'speechIdC', 'speechIdD', 'speechIdE', 'speechIdF', 'speechIdG', 'speechIdH'];
            
            options.forEach((optionId, index) => {
                const value = document.getElementById(optionId).value.trim();
                if (value) {
                    question.phuong_an[optionKeys[index]] = value;
                    
                    // Add corresponding speech ID
                    const speechValue = document.getElementById(speechOptions[index]).value.trim();
                    if (speechValue) {
                        question[`speech_id_options_${optionKeys[index].toUpperCase()}`] = speechValue;
                    }
                }
            });
            
            // Use enhanced validation
            if (!validateQuestionForm(question)) {
                return;
            }
            
            if (editingIndex >= 0) {
                questions[editingIndex] = question;
                editingIndex = -1;
                showToast('Đã cập nhật câu hỏi thành công!');
                setFormMode('add');
            } else {
                questions.push(question);
                showToast('Đã thêm câu hỏi mới thành công!');
            }
            
            saveQuestions();
            filterAndDisplayQuestions();
            clearForm();
        }

        // Set form mode (add/edit)
        function setFormMode(mode) {
            const title = document.getElementById('formTitle');
            const submitBtn = document.getElementById('submitBtnText');
            
            if (mode === 'edit') {
                title.textContent = 'Chỉnh sửa câu hỏi';
                submitBtn.textContent = 'Cập nhật';
            } else {
                title.textContent = 'Thêm câu hỏi mới';
                submitBtn.textContent = 'Lưu câu hỏi';
            }
        }

        // Edit question
        function editQuestion(index) {
            const q = questions[index];
            editingIndex = index;
            setFormMode('edit');
            
            document.getElementById('questionId').value = q.id;
            document.getElementById('questionContent').value = q.cau_hoi;
            document.getElementById('questionType').value = q.type_question;
            document.getElementById('category').value = q.category;
            document.getElementById('round').value = q.round;
            
            // Clear all options first
            ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(letter => {
                document.getElementById(`option${letter}`).value = q.phuong_an[letter.toLowerCase()] || '';
                document.getElementById(`speechId${letter}`).value = q[`speech_id_options_${letter}`] || '';
            });
            
            // Show/hide options based on available data
            updateOptionsDisplay(q.phuong_an);
            
            document.getElementById('correctAnswer').value = q.dap_an_dung || '';
            document.getElementById('useImage').checked = q.use_image === 'Yes';
            document.getElementById('questionImage').checked = q.question_image === 'Yes';
            document.getElementById('imageId').value = q.image_id || '';
            document.getElementById('bgImage').value = q.bg_image || '';
            document.getElementById('positionImage').value = q.position_image || 'Right';
            document.getElementById('speechIdQuestion').value = q.speech_id_question || '';
            document.getElementById('speechIdAnswer').value = q.speech_id_answer || '';
            
            // Show/hide image section
            toggleImageSection();
            
            // Trigger form updates based on question type
            handleQuestionTypeChange();
            
            // Scroll to form
            document.getElementById('questionForm').scrollIntoView({ behavior: 'smooth' });
        }

        // Clear form
        function clearForm() {
            document.getElementById('questionForm').reset();
            editingIndex = -1;
            setFormMode('add');
            
            // Clear all option inputs
            ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'].forEach(letter => {
                document.getElementById(`option${letter}`).value = '';
                document.getElementById(`speechId${letter}`).value = '';
            });
            
            // Clear additional fields
            document.getElementById('correctAnswer').value = '';
            document.getElementById('imageId').value = '';
            document.getElementById('bgImage').value = '';
            document.getElementById('speechIdQuestion').value = '';
            document.getElementById('speechIdAnswer').value = '';
            document.getElementById('positionImage').value = 'Right';
            document.getElementById('useImage').checked = false;
            document.getElementById('questionImage').checked = false;
            
            // Hide extra options (E-H)
            ['optionE', 'optionF', 'optionG', 'optionH'].forEach(optionId => {
                const optionDiv = document.getElementById(optionId).parentElement;
                optionDiv.style.display = 'none';
            });
            
            // Hide extra speech options
            ['speechIdE', 'speechIdF', 'speechIdG', 'speechIdH'].forEach(speechId => {
                document.getElementById(speechId).style.display = 'none';
            });
            
            // Show add option button
            document.getElementById('addOptionBtn').style.display = 'block';
            
            toggleImageSection();
            handleQuestionTypeChange();
        }

        // Toggle image section
        function toggleImageSection() {
            const useImage = document.getElementById('useImage').checked;
            const imageSection = document.getElementById('imageIdSection');
            
            if (useImage) {
                imageSection.classList.remove('hidden');
            } else {
                imageSection.classList.add('hidden');
                document.getElementById('imageId').value = '';
            }
        }

        // Handle question type change to show/hide relevant fields
        function handleQuestionTypeChange() {
            const questionType = document.getElementById('questionType').value;
            const optionsSection = document.querySelector('.mb-4:has(#optionA)'); // The "Phương án trả lời" section
            const correctAnswerDiv = document.querySelector('div:has(#correctAnswer)'); // The "Đáp án đúng" section
            
            // Get all option input elements and correct answer select
            const optionInputs = ['optionA', 'optionB', 'optionC', 'optionD'];
            const correctAnswerSelect = document.getElementById('correctAnswer');
            
            if (questionType === 'Thực hành' || questionType === 'Lý thuyết tự luận') {
                // Hide multiple choice sections for practical and theory questions
                if (optionsSection) {
                    optionsSection.style.display = 'none';
                }
                if (correctAnswerDiv) {
                    correctAnswerDiv.style.display = 'none';
                }
                
                // Clear option values when hidden to avoid validation issues
                optionInputs.forEach(optionId => {
                    const element = document.getElementById(optionId);
                    if (element) {
                        element.value = '';
                        element.removeAttribute('required');
                    }
                });
                
                // Clear correct answer selection
                if (correctAnswerSelect) {
                    correctAnswerSelect.value = '';
                    correctAnswerSelect.removeAttribute('required');
                }
                
            } else {
                // Show multiple choice sections for multiple choice questions
                if (optionsSection) {
                    optionsSection.style.display = 'block';
                }
                if (correctAnswerDiv) {
                    correctAnswerDiv.style.display = 'block';
                }
                
                // Restore required attribute for option A and B (minimum required)
                const optionA = document.getElementById('optionA');
                const optionB = document.getElementById('optionB');
                if (optionA) optionA.setAttribute('required', '');
                if (optionB) optionB.setAttribute('required', '');
            }
            
            // Update placeholder text based on question type
            const questionContent = document.getElementById('questionContent');
            
            if (questionContent) {
                switch (questionType) {
                    case 'Trắc nghiệm':
                        questionContent.placeholder = 'Nhập nội dung câu hỏi trắc nghiệm...';
                        break;
                    case 'Thực hành':
                        questionContent.placeholder = 'Nhập mô tả bài tập thực hành...';
                        break;
                    case 'Lý thuyết tự luận':
                        questionContent.placeholder = 'Nhập câu hỏi lý thuyết tự luận...';
                        break;
                }
            }
        }

        // Enhanced form validation for different question types
        function validateQuestionForm(question) {
            const questionType = question.type_question;
            
            // Basic validation for all question types
            if (!question.id || !question.cau_hoi) {
                showToast('Vui lòng nhập đầy đủ ID câu hỏi và nội dung!', 'error');
                return false;
            }
            
            // Validation specific to multiple choice questions
            if (questionType === 'Trắc nghiệm') {
                if (Object.keys(question.phuong_an).length < 2) {
                    showToast('Câu hỏi trắc nghiệm cần ít nhất 2 phương án!', 'error');
                    return false;
                }
                
                // Check if correct answer exists in options
                if (!question.phuong_an[question.dap_an_dung]) {
                    showToast('Đáp án đúng phải tồn tại trong các phương án!', 'error');
                    return false;
                }
            } else {
                // For practical and theory questions, options are not required
                // Clear any remaining option data to keep the question clean
                question.phuong_an = {};
            }
            
            // Check duplicate ID (except when editing)
            const existingIndex = questions.findIndex(q => q.id === question.id);
            if (existingIndex !== -1 && existingIndex !== editingIndex) {
                showToast('ID câu hỏi đã tồn tại!', 'error');
                return false;
            }
            
            return true;
        }

        // Filter and display questions
        function filterAndDisplayQuestions() {
            const categoryFilter = document.getElementById('filterCategory').value;
            const roundFilter = document.getElementById('filterRound').value;
            const searchTerm = document.getElementById('searchQuestions').value.toLowerCase();

            const filteredQuestions = questions.filter(question => {
                const matchesCategory = !categoryFilter || question.category === categoryFilter;
                const matchesRound = !roundFilter || question.round === roundFilter;
                const matchesSearch = !searchTerm || 
                    question.cau_hoi.toLowerCase().includes(searchTerm) ||
                    question.id.toLowerCase().includes(searchTerm);
                
                return matchesCategory && matchesRound && matchesSearch;
            });

            displayQuestions(filteredQuestions);
        }

        // Display questions in the list
        function displayQuestions(questionsToShow) {
            const questionsList = document.getElementById('questionsList');
            
            if (questionsToShow.length === 0) {
                questionsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
                        <p>Không tìm thấy câu hỏi nào phù hợp với bộ lọc.</p>
                    </div>
                `;
                return;
            }

            questionsList.innerHTML = questionsToShow.map((question, index) => {
                const actualIndex = questions.indexOf(question);
                return `
                    <div class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow ${getCategoryClass(question.category)}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-bold text-lg text-blue-600">${question.id}</span>
                                    <span class="px-2 py-1 rounded text-xs ${getCategoryClass(question.category)}">${categoryLabels[question.category] || question.category}</span>
                                    <span class="px-2 py-1 rounded text-xs ${getTypeClass(question.type_question)}">${question.type_question}</span>
                                    <span class="px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">Vòng ${question.round}</span>
                                </div>
                                <p class="text-gray-700 mb-2 line-clamp-2">${question.cau_hoi}</p>
                                ${Object.keys(question.phuong_an).length > 0 ? 
                                    `<div class="text-sm text-gray-600">
                                        <span class="font-medium">Các phương án:</span> ${Object.keys(question.phuong_an).join(', ')} |
                                        <span class="font-medium">Đáp án:</span> <span class="text-green-600 font-bold">${question.dap_an_dung}</span>
                                    </div>` : ''
                                }
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="editQuestion(${actualIndex})" 
                                        class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded border border-blue-200 hover:bg-blue-50 text-sm">
                                    <i class="fas fa-edit mr-1"></i>Sửa
                                </button>
                                <button onclick="deleteQuestion(${actualIndex})" 
                                        class="text-red-600 hover:text-red-800 px-3 py-1 rounded border border-red-200 hover:bg-red-50 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Xóa
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get category class for styling
        function getCategoryClass(category) {
            return categoryColors[category] || 'bg-gray-100 text-gray-800';
        }

        // Get question type class for styling
        function getTypeClass(type) {
            const typeClasses = {
                'Trắc nghiệm': 'bg-blue-100 text-blue-800',
                'Thực hành': 'bg-green-100 text-green-800',
                'Lý thuyết tự luận': 'bg-purple-100 text-purple-800'
            };
            return typeClasses[type] || 'bg-gray-100 text-gray-800';
        }

        // Compose tab functions (placeholder)
        function filterAvailableQuestions() {
<<<<<<< HEAD
            // This will be implemented with the compose functionality
        }
=======
            console.log('Filtering available questions for compose tab');
            const filterRound = document.getElementById('composeFilterRound').value;
            const filterCategory = document.getElementById('composeFilterCategory').value;
            const searchTerm = document.getElementById('composeSearch').value.toLowerCase();
            
            const filteredQuestions = questions.filter(question => {
                const matchesRound = !filterRound || question.round === filterRound;
                const matchesCategory = !filterCategory || question.category === filterCategory;
                const matchesSearch = !searchTerm || 
                    (question.id || '').toLowerCase().includes(searchTerm) ||
                    (question.cau_hoi || '').toLowerCase().includes(searchTerm);
                return matchesRound && matchesCategory && matchesSearch;
            });
            
            displayAvailableQuestions(filteredQuestions);
        }        function displayAvailableQuestions(questionsToShow) {
            const container = document.getElementById('availableQuestions');
            
            if (questionsToShow.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-question-circle text-2xl mb-2 opacity-50"></i>
                        <p class="text-sm">Không có câu hỏi nào</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = questionsToShow.map((question, index) => {
                const originalIndex = questions.indexOf(question);
                const isInSet = currentQuestionSet.find(q => q.id === question.id);
                return `
                    <div class="question-item-compose border rounded-lg p-3 hover:shadow-md transition-all cursor-pointer ${getCategoryClass(question.category)} ${isInSet ? 'opacity-50 bg-gray-100' : 'drag-item hover:scale-105'}" 
                         draggable="${!isInSet}" data-question-index="${originalIndex}" 
                         onclick="${!isInSet ? `addToQuestionSet(${originalIndex})` : ''}">
                        <div class="flex items-center justify-between mb-1">
                            <span class="font-bold text-sm text-blue-600">${question.id}</span>
                            <div class="flex items-center space-x-1">
                                <span class="px-2 py-1 rounded text-xs ${getTypeClass(question.type_question)}">${question.type_question}</span>
                                ${isInSet ? '<i class="fas fa-check text-green-600"></i>' : '<i class="fas fa-plus text-gray-400"></i>'}
                            </div>
                        </div>
                        <p class="text-xs text-gray-700 mb-1 line-clamp-2">${question.cau_hoi.substring(0, 80)}${question.cau_hoi.length > 80 ? '...' : ''}</p>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>${question.category}</span>
                            <span>Vòng ${question.round}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Re-add drag event listeners to new draggable elements
            container.querySelectorAll('.drag-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
        }// Question set management
        let currentQuestionSet = [];
          // Drag and drop functionality
        function initializeDragAndDrop() {
            const availableQuestions = document.getElementById('availableQuestions');
            const questionSetsList = document.getElementById('questionSetsList');
            
            // Add drag event listeners to available questions container
            if (availableQuestions) {
                availableQuestions.addEventListener('dragstart', handleDragStart);
                availableQuestions.addEventListener('dragend', handleDragEnd);
            }
            
            // Add drop event listeners to question sets container
            if (questionSetsList) {
                questionSetsList.addEventListener('dragover', handleDragOver);
                questionSetsList.addEventListener('drop', handleDrop);
                questionSetsList.addEventListener('dragenter', handleDragEnter);
                questionSetsList.addEventListener('dragleave', handleDragLeave);
            }
            
            // Attach drop listeners to each question drop-zone
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleZoneDrop);
            });
            console.log('Drag and drop initialized');
        }
        
        let draggedQuestionIndex = null;
        
        function handleDragStart(e) {
            if (e.target.classList.contains('drag-item')) {
                draggedQuestionIndex = parseInt(e.target.dataset.questionIndex);
                e.target.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
            }
        }
        
        function handleDragEnd(e) {
            if (e.target.classList.contains('drag-item')) {
                e.target.style.opacity = '1';
            }
            draggedQuestionIndex = null;
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }
        
        function handleDragEnter(e) {
            e.preventDefault();
            const container = document.getElementById('questionSetsList');
            container.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            // Only remove highlight if we're actually leaving the container
            if (!e.currentTarget.contains(e.relatedTarget)) {
                const container = document.getElementById('questionSetsList');
                container.classList.remove('drag-over');
            }
        }
          function handleDrop(e) {
            e.preventDefault();
            const container = document.getElementById('questionSetsList');
            container.classList.remove('drag-over');
            
            if (draggedQuestionIndex !== null) {
                addToQuestionSet(draggedQuestionIndex);
            }
        }
          // Handle dropping into individual round cells
function handleZoneDrop(e) {
    e.preventDefault();
    const zone = e.currentTarget;
    const round = zone.getAttribute('data-round');
    const domain = zone.getAttribute('data-domain');
    const setIndex = zone.getAttribute('data-set-index');
    if (draggedQuestionIndex === null) return;
    // Clone question to assign context
    const question = JSON.parse(JSON.stringify(questions[draggedQuestionIndex]));
    question.round = round;
    if (domain) question.domain = domain;
    if (setIndex) question.setIndex = setIndex;
    currentQuestionSet.push(question);
    displayQuestionSets();
    showToast(`Đã thêm câu hỏi ${question.id} vào Vòng ${round}${domain ? ` - ${zone.querySelector('p').textContent}` : ''}`);
}
          function displayQuestionSets() {
            const container = document.getElementById('questionSetsList');
            
            if (currentQuestionSet.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-4">
                        <i class="fas fa-list-alt text-2xl mb-2 opacity-50"></i>
                        <p class="text-sm">Chưa có câu hỏi nào trong bộ</p>
                        <p class="text-xs mt-1">Kéo thả câu hỏi từ danh sách bên trái</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentQuestionSet.map((question, index) => `
                <div class="question-set-item border rounded-lg p-3 hover:shadow-md transition-shadow ${getCategoryClass(question.category)}" 
                     data-set-index="${index}">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-sm text-blue-600">${question.id}</span>
                            <span class="px-2 py-1 rounded text-xs ${getTypeClass(question.type_question)}">${question.type_question}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500">${index + 1}</span>
                            <button onclick="removeFromQuestionSet(${index})" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-700 mb-1 line-clamp-2">${question.cau_hoi.substring(0, 100)}${question.cau_hoi.length > 100 ? '...' : ''}</p>
                    <div class="flex items-center justify-between text-xs text-gray-500">
                        <span>${question.category}</span>
                        <span>Vòng ${question.round}</span>
                    </div>
                </div>
            `).join('');
            
            // Update question count and stats
            updateQuestionSetStats();
        }
        
        function updateQuestionSetStats() {
            const countElement = document.getElementById('questionSetCount');
            if (countElement) {
                countElement.textContent = currentQuestionSet.length;
            }
            
            // Count by rounds
            const roundCounts = { '1': 0, '2': 0, '3': 0 };
            currentQuestionSet.forEach(q => {
                if (roundCounts[q.round] !== undefined) {
                    roundCounts[q.round]++;
                }
            });
            
            // Display round statistics in header or create a stats section
            const statsHTML = `
                <div class="flex space-x-4 text-xs text-gray-600 mt-2">
                    <span>Vòng 1: ${roundCounts['1']}</span>
                    <span>Vòng 2: ${roundCounts['2']}</span>
                    <span>Vòng 3: ${roundCounts['3']}</span>
                    <span>Tổng: ${currentQuestionSet.length}</span>
                </div>
            `;
            
            // Find or create stats container
            let statsContainer = document.getElementById('questionSetStats');
            if (!statsContainer) {
                const header = document.querySelector('#questionSetsList').parentElement.previousElementSibling;
                statsContainer = document.createElement('div');
                statsContainer.id = 'questionSetStats';
                header.appendChild(statsContainer);
            }
            statsContainer.innerHTML = statsHTML;
        }
          function addToQuestionSet(questionIndex) {
            const question = questions[questionIndex];
            if (!question) return;
            
            // Check if question is already in set
            if (currentQuestionSet.find(q => q.id === question.id)) {
                showToast('Câu hỏi này đã có trong bộ!', 'error');
                return;
            }
            
            currentQuestionSet.push(question);
            displayQuestionSets();
            filterAvailableQuestions(); // Refresh available questions to show updated state
            showToast(`Đã thêm câu hỏi ${question.id} vào bộ!`);
        }
        
        function removeFromQuestionSet(index) {
            const question = currentQuestionSet[index];
            currentQuestionSet.splice(index, 1);
            displayQuestionSets();
            filterAvailableQuestions(); // Refresh available questions to show updated state
            showToast(`Đã xóa câu hỏi ${question.id} khỏi bộ!`);
        }
        
        function saveQuestionSet() {
  // Build updated structure
  const newSets = { vong1: {}, vong2: {}, vong3: {} };
  currentQuestionSet.forEach(q => {
    const id = q.id;
    if (q.round === '1') {
      newSets.vong1['1'] = newSets.vong1['1'] || [];
      newSets.vong1['1'].push(id);
    } else if (q.round === '2') {
      newSets.vong2[q.domain] = newSets.vong2[q.domain] || {};
      newSets.vong2[q.domain][q.setIndex] = newSets.vong2[q.domain][q.setIndex] || [];
      newSets.vong2[q.domain][q.setIndex].push(id);
    } else if (q.round === '3') {
      newSets.vong3[q.setIndex] = newSets.vong3[q.setIndex] || [];
      newSets.vong3[q.setIndex].push(id);
    }
  });
  // Merge into questionSets
  questionSets = newSets;
  // Trigger download to overwrite file
  const blob = new Blob([JSON.stringify(questionSets, null, 2)], { type: 'application/json' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = 'question_sets.json';
  link.click();
  showToast('Đã lưu cấu hình bộ câu hỏi!', 'success');
  renderSavedSets();
}
>>>>>>> v2

        function displayQuestionSets() {
            // This will be implemented with the compose functionality
        }

        function initRoundTabs() {
            // This will be implemented with the round system
        }

        // Configuration for dynamic round sets
const round2Config = [
  { domainKey: 'ly_thuyet_bao_quan_boc_xep_van_chuyen', displayName: 'Lý thuyết bảo quản, bốc xếp, vận chuyển VLNCN', sets: 5 },
  { domainKey: 'ly_thuyet_bao_ve', displayName: 'Lý thuyết bảo vệ', sets: 8 },
  { domainKey: 'ly_thuyet_khai_thac_mo', displayName: 'Lý thuyết khai thác mỏ', sets: 8 }
];
const round3Config = [
  { domainKey: 'y_te_thuc_hanh', displayName: 'Y tế - Thực hành', sets: 6 },
  { domainKey: 'phong_chay_chua_chay', displayName: 'PCCC - Thực hành', sets: 11 }
];

// Render dynamic containers for Round 2 and Round 3
function renderRoundContainers() {
  // Render Round 2
  const r2 = document.getElementById('round2Container');
  r2.innerHTML = '';
  round2Config.forEach(cfg => {
    const domainDiv = document.createElement('div');
    domainDiv.className = 'mb-4';
    domainDiv.innerHTML = `<h4 class="font-semibold mb-2">${cfg.displayName}</h4>`;
    const setsDiv = document.createElement('div');
    setsDiv.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2';
    for (let i = 1; i <= cfg.sets; i++) {
      const dz = document.createElement('div');
      dz.className = 'border-2 border-dashed border-gray-300 rounded-lg p-2 drop-zone';
      dz.setAttribute('data-round', '2');
      dz.setAttribute('data-domain', cfg.domainKey);
      dz.setAttribute('data-set-index', i);
      dz.innerHTML = `<p class="text-center text-gray-500 text-sm">Bộ ${i}</p><div class="min-h-16"></div>`;
      setsDiv.appendChild(dz);
    }
    domainDiv.appendChild(setsDiv);
    r2.appendChild(domainDiv);
  });

  // Render Round 3
  const container3 = document.getElementById('round3Questions');
  container3.innerHTML = '';
  round3Config.forEach(cfg => {
    const domainDiv = document.createElement('div');
    domainDiv.className = 'mb-4';
    domainDiv.innerHTML = `<h4 class="font-semibold mb-2">${cfg.displayName}</h4>`;
    const setsDiv = document.createElement('div');
    setsDiv.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2';
    for (let i = 1; i <= cfg.sets; i++) {
      const dz = document.createElement('div');
      dz.className = 'border-2 border-dashed border-gray-300 rounded-lg p-2 drop-zone';
      dz.setAttribute('data-round', '3');
      dz.setAttribute('data-domain', cfg.domainKey);
      dz.setAttribute('data-set-index', i);
      dz.innerHTML = `<p class="text-center text-gray-500 text-sm">Đề ${i}</p><div class="min-h-16"></div>`;
      setsDiv.appendChild(dz);
    }
    domainDiv.appendChild(setsDiv);
    container3.appendChild(domainDiv);
  });
}

// Initialize after DOM loaded
document.addEventListener('DOMContentLoaded', () => {
  renderRoundContainers();
  initializeDragAndDrop();
  console.log('Dynamic round containers rendered and drag-and-drop initialized');
});
    </script>
</body>
</html>