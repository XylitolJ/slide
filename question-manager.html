<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Câu hỏi Hội thi An toàn Vệ sinh Viên Giỏi 2025</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        .smooth-transition {
            transition: all 0.2s ease;
        }
        
        /* Tab styles */
        .tab-button {
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Drag and drop styles */
        .drag-item {
            cursor: grab;
            transition: all 0.2s ease;
        }
        .drag-item:active {
            cursor: grabbing;
        }
        .drag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .drag-over {
            background-color: #dbeafe;
            border: 2px dashed #3b82f6;
        }
        
        /* Category colors for questions */
        .category-cspl { border-left: 4px solid #3b82f6; }
        .category-pccc { border-left: 4px solid #ef4444; }
        .category-bv { border-left: 4px solid #10b981; }
        .category-ktm { border-left: 4px solid #f59e0b; }
        .category-bxvc { border-left: 4px solid #8b5cf6; }
        
        /* Question preview styles */
        .question-preview {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Drop zone styles */
        .drop-zone {
            min-height: 150px;
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            background-color: #f0f9ff;
            border-color: #3b82f6;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-hard-hat text-3xl mr-4 text-blue-600"></i>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Quản lý Câu hỏi Hội thi</h1>
                        <p class="text-gray-600">An Toàn Vệ Sinh Viên Giỏi 2025</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Tổng câu hỏi</div>
                        <div id="totalQuestions" class="text-xl font-bold text-blue-600">0</div>
                    </div>
                    <button id="loadDataBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg smooth-transition">
                        <i class="fas fa-upload mr-2"></i>Tải dữ liệu
                    </button>
                    <button id="exportAllBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg smooth-transition">
                        <i class="fas fa-download mr-2"></i>Xuất tất cả
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="bg-white border-b">
        <div class="container mx-auto px-4">
            <nav class="flex space-x-8">
                <button class="tab-button active px-4 py-3 text-blue-600 font-medium" data-tab="edit">
                    <i class="fas fa-edit mr-2"></i>Chỉnh sửa câu hỏi
                </button>
                <button class="tab-button px-4 py-3 text-gray-600 font-medium hover:text-blue-600" data-tab="compose">
                    <i class="fas fa-layer-group mr-2"></i>Tạo bộ câu hỏi
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <!-- Tab 1: Edit Questions -->
        <div id="editTab" class="tab-content active">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Question Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <span id="formTitle">Thêm câu hỏi mới</span>
                            </h2>
                        </div>
                        
                        <div class="p-6">
                            <form id="questionForm">
                                <!-- ID và Loại câu hỏi -->
                                <div class="grid grid-cols-1 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-tag mr-1"></i>ID Câu hỏi:
                                        </label>
                                        <input type="text" id="questionId" 
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                               placeholder="VD: CSPL_TN_1" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-list mr-1"></i>Loại câu hỏi:
                                        </label>
                                        <select id="questionType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="Trắc nghiệm">Trắc nghiệm</option>
                                            <option value="Thực hành">Thực hành</option>
                                            <option value="Lý thuyết tự luận">Lý thuyết tự luận</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Nội dung câu hỏi -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-question-circle mr-1"></i>Nội dung câu hỏi:
                                    </label>
                                    <textarea id="questionContent" rows="3" 
                                              class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                              placeholder="Nhập nội dung câu hỏi..." required></textarea>
                                </div>
                                
                                <!-- Phương án trả lời -->
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-list-ul mr-1"></i>Các phương án trả lời:
                                    </label>
                                    <div class="space-y-2">
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-medium">A</span>
                                            <input type="text" id="optionA" placeholder="Phương án A" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-medium">B</span>
                                            <input type="text" id="optionB" placeholder="Phương án B" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-yellow-500 text-white rounded-full flex items-center justify-center text-sm font-medium">C</span>
                                            <input type="text" id="optionC" placeholder="Phương án C" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-sm font-medium">D</span>
                                            <input type="text" id="optionD" placeholder="Phương án D" 
                                                   class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Cài đặt câu hỏi -->
                                <div class="grid grid-cols-1 gap-4 mb-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-check-circle mr-1"></i>Đáp án đúng:
                                        </label>
                                        <select id="correctAnswer" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="a">A</option>
                                            <option value="b">B</option>
                                            <option value="c">C</option>
                                            <option value="d">D</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-clock mr-1"></i>Thời gian (giây):
                                        </label>
                                        <input type="number" id="timeLimit" value="30" min="10" max="300" 
                                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-folder mr-1"></i>Danh mục:
                                        </label>                                        <select id="category" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="CSPL">Chính sách pháp luật</option>
                                            <option value="PCCC">Phòng cháy chữa cháy</option>
                                            <option value="BV">Bảo vệ</option>
                                            <option value="KTM">Khai thác mỏ</option>
                                            <option value="BXVC">Bốc xếp vận chuyển</option>
                                            <option value="YT">Y tế</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">
                                            <i class="fas fa-layer-group mr-1"></i>Vòng thi:
                                        </label>
                                        <select id="round" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                            <option value="1">Vòng 1</option>
                                            <option value="2">Vòng 2</option>
                                            <option value="3">Vòng 3</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Tùy chọn bổ sung -->
                                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                    <h3 class="text-sm font-medium text-gray-700 mb-3">
                                        <i class="fas fa-cog mr-1"></i>Tùy chọn bổ sung:
                                    </h3>
                                    <div class="space-y-3">
                                        <div class="flex items-center">
                                            <input type="checkbox" id="useImage" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <label for="useImage" class="ml-2 text-sm text-gray-700">Có hình ảnh minh họa</label>
                                        </div>
                                        <div id="imageIdSection" class="hidden">
                                            <input type="text" id="imageId" placeholder="Tên file hình ảnh (VD: image1.jpg)" 
                                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Buttons -->
                                <div class="flex space-x-3">
                                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg smooth-transition">
                                        <i class="fas fa-save mr-2"></i>
                                        <span id="submitBtnText">Lưu câu hỏi</span>
                                    </button>
                                    <button type="button" id="clearForm" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg smooth-transition">
                                        <i class="fas fa-times mr-2"></i>Hủy
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-800">
                                    <i class="fas fa-list mr-2"></i>Danh sách Câu hỏi
                                </h2>
                                <div class="flex items-center space-x-4">
                                    <!-- Filter -->
                                    <div class="flex items-center space-x-2">                                        <select id="filterCategory" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                            <option value="">Tất cả danh mục</option>
                                            <option value="CSPL">Chính sách pháp luật</option>
                                            <option value="PCCC">Phòng cháy chữa cháy</option>
                                            <option value="BV">Bảo vệ</option>
                                            <option value="KTM">Khai thác mỏ</option>
                                            <option value="BXVC">Bốc xếp vận chuyển</option>
                                            <option value="YT">Y tế</option>
                                        </select>
                                        <select id="filterRound" class="border border-gray-300 rounded-lg px-3 py-1 text-sm">
                                            <option value="">Tất cả vòng</option>
                                            <option value="1">Vòng 1</option>
                                            <option value="2">Vòng 2</option>
                                            <option value="3">Vòng 3</option>
                                        </select>
                                    </div>
                                    <!-- Search -->
                                    <div class="relative">
                                        <input type="text" id="searchQuestions" placeholder="Tìm kiếm câu hỏi..." 
                                               class="border border-gray-300 rounded-lg px-3 py-1 pl-8 text-sm w-64">
                                        <i class="fas fa-search absolute left-3 top-2 text-gray-400 text-sm"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <div id="questionsList" class="space-y-4">
                                <!-- Questions will be displayed here -->
                                <div class="text-center text-gray-500 py-8">
                                    <i class="fas fa-question-circle text-4xl mb-4 opacity-50"></i>
                                    <p>Chưa có câu hỏi nào. Hãy thêm câu hỏi đầu tiên!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Compose Question Sets -->
        <div id="composeTab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <!-- Available Questions -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-database mr-2"></i>Câu hỏi có sẵn
                            </h2>
                        </div>
                        
                        <div class="p-4">
                            <!-- Quick filters -->
                            <div class="space-y-2 mb-4">
                                <select id="composeFilterRound" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">Tất cả vòng</option>
                                    <option value="1">Vòng 1</option>
                                    <option value="2">Vòng 2</option>
                                    <option value="3">Vòng 3</option>
                                </select>                                <select id="composeFilterCategory" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                                    <option value="">Tất cả danh mục</option>
                                    <option value="CSPL">Chính sách pháp luật</option>
                                    <option value="PCCC">Phòng cháy chữa cháy</option>
                                    <option value="BV">Bảo vệ</option>
                                    <option value="KTM">Khai thác mỏ</option>
                                    <option value="BXVC">Bốc xếp vận chuyển</option>
                                    <option value="YT">Y tế</option>
                                </select>
                                <input type="text" id="composeSearch" placeholder="Tìm kiếm..." 
                                       class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm">
                            </div>
                            
                            <div id="availableQuestions" class="space-y-2 max-h-96 overflow-y-auto">
                                <!-- Available questions will be displayed here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Set Builder -->
                <div class="lg:col-span-3">
                    <div class="bg-white rounded-lg shadow-lg">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h2 class="text-xl font-semibold text-gray-800">
                                    <i class="fas fa-layer-group mr-2"></i>Tạo bộ câu hỏi
                                </h2>
                                <div class="flex space-x-2">
                                    <button id="saveQuestionSet" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg smooth-transition">
                                        <i class="fas fa-save mr-2"></i>Lưu bộ đề
                                    </button>
                                    <button id="clearQuestionSet" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg smooth-transition">
                                        <i class="fas fa-trash mr-2"></i>Xóa tất cả
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <!-- Round containers -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <!-- Vòng 1 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 drop-zone" data-round="1">
                                    <h3 class="text-lg font-semibold text-center mb-4 text-blue-600">
                                        <i class="fas fa-trophy mr-2"></i>Vòng 1
                                    </h3>
                                    <div id="round1Questions" class="space-y-2 min-h-32">
                                        <p class="text-center text-gray-500 text-sm">Kéo thả câu hỏi vào đây</p>
                                    </div>
                                </div>
                                
                                <!-- Vòng 2 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 drop-zone" data-round="2">
                                    <h3 class="text-lg font-semibold text-center mb-4 text-green-600">
                                        <i class="fas fa-medal mr-2"></i>Vòng 2
                                    </h3>
                                    <div id="round2Questions" class="space-y-2 min-h-32">
                                        <p class="text-center text-gray-500 text-sm">Kéo thả câu hỏi vào đây</p>
                                    </div>
                                </div>
                                
                                <!-- Vòng 3 -->
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 drop-zone" data-round="3">
                                    <h3 class="text-lg font-semibold text-center mb-4 text-yellow-600">
                                        <i class="fas fa-crown mr-2"></i>Vòng 3
                                    </h3>
                                    <div id="round3Questions" class="space-y-2 min-h-32">
                                        <p class="text-center text-gray-500 text-sm">Kéo thả câu hỏi vào đây</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="toastMessage">Thành công!</span>
            </div>
        </div>
    </div>

    <!-- File Input (Hidden) -->
    <input type="file" id="fileInput" accept=".json" multiple style="display: none;">

    <script>
        // Global variables
        let questions = [];
        let questionSets = {};
        let editingIndex = -1;
        let filteredQuestions = [];
        let currentDraggedQuestion = null;        // Categories mapping
        const categoryLabels = {
            'CSPL': 'Chính sách pháp luật',
            'PCCC': 'Phòng cháy chữa cháy',
            'BV': 'Bảo vệ',
            'KTM': 'Khai thác mỏ',
            'BXVC': 'Bốc xếp vận chuyển',
            'YT': 'Y tế'
        };

        const categoryColors = {
            'CSPL': 'bg-blue-100 text-blue-800',
            'PCCC': 'bg-red-100 text-red-800',
            'BV': 'bg-green-100 text-green-800',
            'KTM': 'bg-yellow-100 text-yellow-800',
            'BXVC': 'bg-purple-100 text-purple-800',
            'YT': 'bg-pink-100 text-pink-800'
        };        // Initialize the application
        function init() {
            setupEventListeners();
            loadQuestions();
            updateTotalCount();
            // Trigger initial form state setup
            handleQuestionTypeChange();
        }// Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });

            // Form submission
            document.getElementById('questionForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('clearForm').addEventListener('click', clearForm);
            document.getElementById('useImage').addEventListener('change', toggleImageSection);
            document.getElementById('questionType').addEventListener('change', handleQuestionTypeChange);

            // Filter and search
            document.getElementById('filterCategory').addEventListener('change', filterAndDisplayQuestions);
            document.getElementById('filterRound').addEventListener('change', filterAndDisplayQuestions);
            document.getElementById('searchQuestions').addEventListener('input', filterAndDisplayQuestions);

            // Compose tab filters
            document.getElementById('composeFilterRound').addEventListener('change', filterAvailableQuestions);
            document.getElementById('composeFilterCategory').addEventListener('change', filterAvailableQuestions);
            document.getElementById('composeSearch').addEventListener('input', filterAvailableQuestions);

            // File operations
            document.getElementById('loadDataBtn').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('fileInput').addEventListener('change', handleFileLoad);
            document.getElementById('exportAllBtn').addEventListener('click', exportToJSON);

            // Question set operations
            document.getElementById('saveQuestionSet').addEventListener('click', saveQuestionSet);
            document.getElementById('clearQuestionSet').addEventListener('click', clearQuestionSet);

            // Setup drag and drop
            setupDragAndDrop();
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600');
                btn.classList.add('text-gray-600');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active', 'text-blue-600');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName === 'edit' ? 'editTab' : 'composeTab').classList.add('active');

            // Refresh compose tab content if switching to it
            if (tabName === 'compose') {
                filterAvailableQuestions();
                displayQuestionSets();
            }
        }

        // Load questions from localStorage
        function loadQuestions() {
            const saved = localStorage.getItem('hoi_thi_questions');
            if (saved) {
                questions = JSON.parse(saved);
                filterAndDisplayQuestions();
                updateTotalCount();
            }
        }

        // Save questions to localStorage
        function saveQuestions() {
            localStorage.setItem('hoi_thi_questions', JSON.stringify(questions));
            updateTotalCount();
        }

        // Update total questions count
        function updateTotalCount() {
            document.getElementById('totalQuestions').textContent = questions.length;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            const toastDiv = toast.firstElementChild;
            if (type === 'success') {
                toastDiv.className = 'bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg';
            } else if (type === 'error') {
                toastDiv.className = 'bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // Handle form submission
        function handleFormSubmit(e) {
            e.preventDefault();
            
            const question = {
                id: document.getElementById('questionId').value.trim(),
                cau_hoi: document.getElementById('questionContent').value.trim(),
                type_question: document.getElementById('questionType').value,
                category: document.getElementById('category').value,
                round: document.getElementById('round').value,
                phuong_an: {},
                dap_an_dung: document.getElementById('correctAnswer').value,
                thoi_gian_tra_loi: parseInt(document.getElementById('timeLimit').value),
                use_image: document.getElementById('useImage').checked ? 'Yes' : 'No',
                image_id: document.getElementById('imageId').value.trim()
            };
            
            // Add non-empty options
            const options = ['optionA', 'optionB', 'optionC', 'optionD'];
            const optionKeys = ['a', 'b', 'c', 'd'];
            
            options.forEach((optionId, index) => {
                const value = document.getElementById(optionId).value.trim();
                if (value) {
                    question.phuong_an[optionKeys[index]] = value;
                }
            });
              // Use enhanced validation
            if (!validateQuestionForm(question)) {
                return;
            }
            
            if (editingIndex >= 0) {
                questions[editingIndex] = question;
                editingIndex = -1;
                showToast('Đã cập nhật câu hỏi thành công!');
                setFormMode('add');
            } else {
                questions.push(question);
                showToast('Đã thêm câu hỏi mới thành công!');
            }
            
            saveQuestions();
            filterAndDisplayQuestions();
            clearForm();
        }

        // Set form mode (add/edit)
        function setFormMode(mode) {
            const title = document.getElementById('formTitle');
            const submitBtn = document.getElementById('submitBtnText');
            
            if (mode === 'edit') {
                title.textContent = 'Chỉnh sửa câu hỏi';
                submitBtn.textContent = 'Cập nhật';
            } else {
                title.textContent = 'Thêm câu hỏi mới';
                submitBtn.textContent = 'Lưu câu hỏi';
            }
        }

        // Edit question
        function editQuestion(index) {
            const q = questions[index];
            editingIndex = index;
            setFormMode('edit');
            
            document.getElementById('questionId').value = q.id;
            document.getElementById('questionContent').value = q.cau_hoi;
            document.getElementById('questionType').value = q.type_question;
            document.getElementById('category').value = q.category;
            document.getElementById('round').value = q.round;
            document.getElementById('optionA').value = q.phuong_an.a || '';
            document.getElementById('optionB').value = q.phuong_an.b || '';
            document.getElementById('optionC').value = q.phuong_an.c || '';
            document.getElementById('optionD').value = q.phuong_an.d || '';
            document.getElementById('correctAnswer').value = q.dap_an_dung;
            document.getElementById('timeLimit').value = q.thoi_gian_tra_loi;
            document.getElementById('useImage').checked = q.use_image === 'Yes';
            document.getElementById('imageId').value = q.image_id || '';
            
            // Show/hide image section
            toggleImageSection();
            
            // Trigger form updates based on question type
            handleQuestionTypeChange();
            
            // Scroll to form
            document.getElementById('questionForm').scrollIntoView({ behavior: 'smooth' });        }

        // Clear form
        function clearForm() {
            document.getElementById('questionForm').reset();
            document.getElementById('timeLimit').value = 30;
            editingIndex = -1;
            setFormMode('add');
            toggleImageSection();
            handleQuestionTypeChange(); // Reset form fields based on question type
        }

        // Toggle image section
        function toggleImageSection() {
            const useImage = document.getElementById('useImage').checked;
            const imageSection = document.getElementById('imageIdSection');
            
            if (useImage) {
                imageSection.classList.remove('hidden');
            } else {
                imageSection.classList.add('hidden');
                document.getElementById('imageId').value = '';
            }
        }

        // Handle question type change to show/hide relevant fields
        function handleQuestionTypeChange() {
            const questionType = document.getElementById('questionType').value;
            const optionsSection = document.querySelector('.mb-4:has(#optionA)'); // The "Phương án trả lời" section
            const correctAnswerDiv = document.querySelector('div:has(#correctAnswer)'); // The "Đáp án đúng" section
            
            // Get all option input elements and correct answer select
            const optionInputs = ['optionA', 'optionB', 'optionC', 'optionD'];
            const correctAnswerSelect = document.getElementById('correctAnswer');
            
            if (questionType === 'Thực hành' || questionType === 'Lý thuyết tự luận') {
                // Hide multiple choice sections for practical and theory questions
                if (optionsSection) {
                    optionsSection.style.display = 'none';
                }
                if (correctAnswerDiv) {
                    correctAnswerDiv.style.display = 'none';
                }
                
                // Clear option values when hidden to avoid validation issues
                optionInputs.forEach(optionId => {
                    const input = document.getElementById(optionId);
                    if (input) {
                        input.value = '';
                        input.removeAttribute('required');
                    }
                });
                
                // Clear correct answer selection
                if (correctAnswerSelect) {
                    correctAnswerSelect.value = 'a'; // Reset to default
                }
                
            } else {
                // Show multiple choice sections for multiple choice questions
                if (optionsSection) {
                    optionsSection.style.display = 'block';
                }
                if (correctAnswerDiv) {
                    correctAnswerDiv.style.display = 'block';
                }
                
                // Restore required attribute for option A and B (minimum required)
                const optionA = document.getElementById('optionA');
                const optionB = document.getElementById('optionB');
                if (optionA) optionA.setAttribute('required', '');
                if (optionB) optionB.setAttribute('required', '');
            }
            
            // Update placeholder text and time limit based on question type
            const questionContent = document.getElementById('questionContent');
            const timeLimit = document.getElementById('timeLimit');
            
            if (questionContent) {
                switch (questionType) {
                    case 'Trắc nghiệm':
                        questionContent.placeholder = 'Nhập nội dung câu hỏi trắc nghiệm...';
                        if (timeLimit) timeLimit.value = 30;
                        break;
                    case 'Thực hành':
                        questionContent.placeholder = 'Nhập nội dung câu hỏi thực hành...';
                        if (timeLimit) timeLimit.value = 300; // 5 minutes for practical questions
                        break;
                    case 'Lý thuyết tự luận':
                        questionContent.placeholder = 'Nhập nội dung câu hỏi lý thuyết...';
                        if (timeLimit) timeLimit.value = 120; // 2 minutes for theory questions
                        break;
                }
            }
        }

        // Enhanced form validation for different question types
        function validateQuestionForm(question) {
            const questionType = question.type_question;
            
            // Basic validation for all question types
            if (!question.id || !question.cau_hoi) {
                showToast('Vui lòng nhập đầy đủ ID câu hỏi và nội dung!', 'error');
                return false;
            }
            
            // Validation specific to multiple choice questions
            if (questionType === 'Trắc nghiệm') {
                if (Object.keys(question.phuong_an).length < 2) {
                    showToast('Câu hỏi trắc nghiệm cần ít nhất 2 phương án trả lời!', 'error');
                    return false;
                }
                
                // Check if correct answer exists in options
                if (!question.phuong_an[question.dap_an_dung]) {
                    showToast('Đáp án đúng phải có nội dung phương án tương ứng!', 'error');
                    return false;
                }
            } else {
                // For practical and theory questions, options are not required
                // Clear any remaining option data to keep the question clean
                question.phuong_an = {};
                question.dap_an_dung = ''; // No correct answer for non-multiple choice
            }
            
            // Check duplicate ID (except when editing)
            const existingIndex = questions.findIndex(q => q.id === question.id);
            if (existingIndex !== -1 && existingIndex !== editingIndex) {
                showToast('ID câu hỏi đã tồn tại!', 'error');
                return false;
            }
              return true;
        }

        // Filter and display questions
        function filterAndDisplayQuestions() {
            const categoryFilter = document.getElementById('filterCategory').value;
            const roundFilter = document.getElementById('filterRound').value;
            const searchTerm = document.getElementById('searchQuestions').value.toLowerCase();

            const filteredQuestions = questions.filter(question => {
                const matchesCategory = !categoryFilter || question.category === categoryFilter;
                const matchesRound = !roundFilter || question.round === roundFilter;
                const matchesSearch = !searchTerm || 
                    question.id.toLowerCase().includes(searchTerm) ||
                    question.cau_hoi.toLowerCase().includes(searchTerm);
                return matchesCategory && matchesRound && matchesSearch;
            });

            displayQuestions(filteredQuestions);
        }

        // Display questions in the list
        function displayQuestions(questionsToShow) {
            const questionsList = document.getElementById('questionsList');
            
            if (questionsToShow.length === 0) {
                questionsList.innerHTML = '<div class="text-center py-8 text-gray-500">Không có câu hỏi nào</div>';
                return;
            }

            questionsList.innerHTML = questionsToShow.map((question, index) => {
                const originalIndex = questions.indexOf(question);
                const categoryClass = getCategoryClass(question.category);
                
                return `
                    <div class="question-item border rounded-lg p-4 hover:shadow-md transition-shadow ${categoryClass}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-bold text-blue-600">${question.id}</span>
                                <span class="px-2 py-1 rounded text-xs ${getTypeClass(question.type_question)}">${question.type_question}</span>
                                <span class="px-2 py-1 rounded text-xs bg-gray-100">${question.category}</span>
                                <span class="px-2 py-1 rounded text-xs bg-gray-100">Vòng ${question.round}</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editQuestion(${originalIndex})" class="text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteQuestion(${originalIndex})" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-gray-700 mb-2">${question.cau_hoi}</p>
                        ${Object.keys(question.phuong_an).length > 0 ? `
                            <div class="text-sm text-gray-600">
                                <strong>Phương án:</strong> ${Object.entries(question.phuong_an).map(([key, value]) => `${key.toUpperCase()}: ${value}`).join(', ')}
                            </div>
                            <div class="text-sm text-green-600">
                                <strong>Đáp án:</strong> ${question.dap_an_dung.toUpperCase()}
                            </div>
                        ` : ''}
                        <div class="text-sm text-gray-500 mt-2">
                            <i class="fas fa-clock mr-1"></i>Thời gian: ${question.thoi_gian_tra_loi}s
                            ${question.use_image === 'Yes' ? `<i class="fas fa-image ml-3 mr-1"></i>Có hình ảnh` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get category class for styling
        function getCategoryClass(category) {
            const categoryClasses = {
                'CSPL': 'category-cspl',
                'PCCC': 'category-pccc', 
                'BV': 'category-bv',
                'KTM': 'category-ktm',
                'BXVC': 'category-bxvc',
                'YT': 'category-yt'
            };
            return categoryClasses[category] || '';
        }

        // Get question type class for styling
        function getTypeClass(type) {
            const typeClasses = {
                'Trắc nghiệm': 'bg-blue-100 text-blue-800',
                'Thực hành': 'bg-green-100 text-green-800',
                'Lý thuyết tự luận': 'bg-purple-100 text-purple-800'
            };
            return typeClasses[type] || 'bg-gray-100 text-gray-800';        }

        // Compose tab functions
        function filterAvailableQuestions() {
            // This is a placeholder for compose tab functionality
            console.log('Filtering available questions for compose tab');
        }

        function displayQuestionSets() {
            // This is a placeholder for displaying question sets
            console.log('Displaying question sets');
        }

        function setupDragAndDrop() {
            // This is a placeholder for drag and drop functionality
            console.log('Setting up drag and drop');
        }

        function saveQuestionSet() {
            // This is a placeholder for saving question sets
            console.log('Saving question set');
        }

        function clearQuestionSet() {
            // This is a placeholder for clearing question sets
            console.log('Clearing question set');
        }

        function handleFileLoad() {
            // This is a placeholder for file loading
            console.log('Loading file');
        }

        function exportToJSON() {
            // This is a placeholder for exporting to JSON
            console.log('Exporting to JSON');
        }

        // Delete question
        function deleteQuestion(index) {
            const question = questions[index];
            if (confirm(`Bạn có chắc muốn xóa câu hỏi "${question.id}"?`)) {
                questions.splice(index, 1);
                saveQuestions();
                filterAndDisplayQuestions();
                showToast('Đã xóa câu hỏi thành công!');
                
                // Reset form if editing this question
                if (editingIndex === index) {
                    clearForm();
                }
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>