<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Hình ảnh Câu hỏi - ATVSV 2025</title>
    
    <!-- Auth protection -->
    <script src="auth.js"></script>
    <script>
        if (!window.slideAuth.requireAuth()) {
            document.addEventListener('DOMContentLoaded', function() {
                document.body.style.display = 'none';
            });
        }
    </script>
    
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <!-- Prettier for JSON formatting -->
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
    <style>
        .thumbnail-container {
            width: auto;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            background-color: #f9fafb;
        }
        
        .thumbnail-image {
            height: 80px;
            width: auto;
            object-fit: cover;
        }
        
        .placeholder-thumbnail {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            color: #6b7280;
            border-radius: 4px;
        }
        
        .sidebar {
            width: 300px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
        }
        
        .folder-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .folder-item:hover {
            background-color: #f9fafb;
        }
        
        .folder-item.active {
            background-color: #dbeafe;
            color: #1e40af;
        }
          .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            padding-bottom: 20px; /* Extra padding at bottom */
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            /* Ensure scrollbar is visible */
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        /* Webkit scrollbar styling */
        .image-grid::-webkit-scrollbar {
            width: 8px;
        }
        
        .image-grid::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .image-grid::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .image-grid::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .image-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        
        .image-item:hover {
            border-color: #d1d5db;
        }
        
        .image-item.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .image-item img {
            width: 100px;
            height: 56px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .image-item span {
            font-size: 10px;
            text-align: center;
            margin-top: 4px;
            word-break: break-all;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
          .modal-content {
            width: 90%;
            height: 90%;
            max-width: 1200px;
            max-height: 800px;
            background-color: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .batch-edit-panel {
            display: none;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .question-text {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Modal footer styling */
        .modal-footer {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
        }
        
        /* Ensure proper spacing in image grid container */
        .image-grid-container {
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
    </style>
</head>
<body class="bg-gray-50">    <!-- Header -->
    <div class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4"><div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">
                        Quản lý Hình ảnh Câu hỏi
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        Chỉnh sửa hình ảnh câu hỏi, sau đó click "Save All" để lưu các file đã thay đổi.
                        <span class="text-red-700 font-bold">Chức năng này chỉ hoạt động trên local vì cần lưu đè các file data .json</span>
                    </p>
                </div>
                <div class="flex gap-4"</div>
                    <button onclick="refreshImagesLibrary()" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <i class="fas fa-sync-alt"></i>
                        <span>Refresh Images</span>
                    </button>
                    <button onclick="saveAllFiles()" class="save-all-btn bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg opacity-50" disabled>
                        <i class="fas fa-save mr-2"></i>Save All
                    </button>
                    <button onclick="manualRefreshImages()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-refresh mr-2"></i>Reload Images
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="container mx-auto px-4 py-4">
        <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
            <div class="flex items-center justify-between mb-4">                <div class="flex items-center gap-4">
                    <select id="roundFilter" onchange="filterQuestions()" class="border rounded-lg px-3 py-2">
                        <option value="">Tất cả vòng</option>
                        <option value="1">Vòng 1</option>
                        <option value="2">Vòng 2</option>
                        <option value="3">Vòng 3</option>
                    </select>
                </div>
                <div class="flex items-center gap-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-2">
                        Chọn tất cả
                    </label>
                    <button onclick="toggleBatchEdit()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-edit mr-2"></i>Batch Edit
                    </button>
                </div>
            </div>

            <!-- Batch Edit Panel -->
            <div id="batchEditPanel" class="batch-edit-panel">
                <h3 class="text-lg font-semibold mb-4">Chỉnh sửa hàng loạt</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Use Image</label>
                        <select id="batchUseImage" class="w-full border rounded px-3 py-2">
                            <option value="">Không thay đổi</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Position Image</label>
                        <select id="batchPositionImage" class="w-full border rounded px-3 py-2">
                            <option value="">Không thay đổi</option>
                            <option value="Left">Left</option>
                            <option value="Right">Right</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Question Image</label>
                        <select id="batchQuestionImage" class="w-full border rounded px-3 py-2">
                            <option value="">Không thay đổi</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">BG Overlay</label>
                        <select id="batchBgOverlay" class="w-full border rounded px-3 py-2">
                            <option value="">Không thay đổi</option>
                            <option value="null">None</option>
                            <option value="gradient">Gradient</option>
                            <option value="stripes">Stripes</option>
                        </select>
                    </div>
                </div>
                <div class="mt-4 flex gap-4">
                    <button onclick="showImageGallery('batch', 'image_id')" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                        Gán ảnh chính
                    </button>
                    <button onclick="showImageGallery('batch', 'bg_image')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                        Gán ảnh nền
                    </button>
                    <button onclick="applyBatchEdit()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                        Áp dụng
                    </button>
                    <button onclick="toggleBatchEdit()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded">
                        Hủy
                    </button>
                </div>
            </div>
        </div>

        <!-- Questions Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
            <table class="w-full">                <thead class="bg-gray-50">                    <tr>
                        <th class="px-4 py-3 text-left"></th>
                        <th class="px-4 py-3 text-left">ID</th>
                        <th class="px-4 py-3 text-left">Vòng</th>
                        <th class="px-4 py-3 text-left">Câu số</th>
                        <th class="px-4 py-3 text-left">Câu hỏi</th>
                        <th class="px-4 py-3 text-left">Ảnh chính</th>
                        <th class="px-4 py-3 text-left">Ảnh nền</th>
                        <th class="px-4 py-3 text-left">Thao tác</th>
                    </tr>
                </thead>
                <tbody id="questionsTableBody">
                    <!-- Questions will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="flex items-center justify-between p-4 border-b">
                <h2 class="text-xl font-semibold">Chỉnh sửa hình ảnh câu hỏi</h2>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="flex-1 p-4 overflow-y-auto">
                <form id="editForm">
                    <input type="hidden" id="editIndex">
                      <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3">Cài đặt ảnh</h3>

                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="editUseImage" class="mr-2">
                                    Sử dụng ảnh
                                </label>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Ảnh chính</label>
                                <div class="flex items-center gap-2">
                                    <div id="editImagePreview" class="thumbnail-container">
                                        <div class="placeholder-thumbnail">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <button type="button" onclick="showImageGallery('edit', 'image_id')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded">
                                        Chọn ảnh
                                    </button>
                                </div>
                                <input type="hidden" id="editImageId">
                            </div>

                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="editPositionRight" class="mr-2">
                                    Vị trí ảnh bên phải
                                </label>
                     </label>       </div>

                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="editQuestionImage" class="mr-2">
                                    Question Image
                                </label>
                            </div></label>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-3">Cài đặt nền</h3>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Ảnh nền</label>
                                <div class="flex items-center gap-2">
                                    <div id="editBgImagePreview" class="thumbnail-container">
                                        <div class="placeholder-thumbnail">
                                            <i class="fas fa-image"></i>
                                        </div>
                                    </div>
                                    <button type="button" onclick="showImageGallery('edit', 'bg_image')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded">
                                        Chọn ảnh nền
                                    </button>
                                </div>
                                <input type="hidden" id="editBgImage">
                            </div>

                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="editGradientOverlay" class="mr-2">
                                    Gradient Overlay
                                </label>
                            </div>

                            <div class="mb-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="editStripesOverlay" class="mr-2">
                                    Stripes Overlay
                                </label>
                            </div>
                      </label>  </div>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t flex justify-end gap-4">
                <button onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                    Hủy
                </button>
                <button onclick="saveQuestion()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                    Lưu
                </button>
            </div>
        </div>
    </div>

    <!-- Image Gallery Modal -->
    <div id="imageGalleryModal" class="modal" style="display: none;">
        <div class="modal-content">            <div class="flex </button>items-center justify-between p-4 border-b">
                <div>
                    <h2 class="text-xl font-semibold">Chọn hình ảnh</h2>
                </div>
                <button onclick="closeImageGallery()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>            <div class="flex-1 flex min-h-0">
                <!-- Sidebar -->                <div class="w-80 p-4 border-r flex-shrink-0">
                    <div class="mb-4">                        <!-- Upload functionality removed -->
                    </div>
                    
                    <h3 class="font-semibold mb-2">Thư mục</h3>
                    <div id="folderTree" class="sidebar">
                        <!-- Folder tree will be populated here -->
                    </div>
                </div>
                
                <!-- Image Grid Container -->
                <div class="flex-1 p-4 flex flex-col min-h-0">
                    <div id="imageGrid" class="image-grid">
                        <!-- Images will be populated here -->
                    </div>
                </div>
            </div>            <div class="p-4 border-t flex justify-end gap-4 modal-footer">
        </div>        <button onclick="closeImageGallery()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                    Hủy
                </button>
                <button onclick="selectImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                    Chọn
                </button>
            </div>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="fixed top-4 right-4 z-50 transform translate-x-full transition-transform duration-300">
        <div class="bg-green-500 text-white px-</button>6 py-3 rounded-lg shadow-lg">
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>        
        // Check if Prettier is loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof prettier !== 'undefined') {
                console.log('✅ Prettier loaded successfully');
            } else {
                console.warn('⚠️ Prettier failed to load, will fallback to JSON.stringify');
            }
        });

        // Global variables
        let allQuestions = [];
        let filteredQuestions = [];
        let vong1Data = null;
        let vong2Data = null;
        let vong3Data = null;
        let selectedQuestions = new Set();
        let currentEditIndex = -1;
        let currentGalleryContext = null;
        let currentGalleryField = null;
        let selectedImagePath = null;
        let availableImages = {};
        
        // Track original data and changes
        let originalData = {
            vong1: null,
            vong2: null,
            vong3: null
        };
        let changedQuestions = new Set();
        
        // Initialize application
        async function init() {
            try {
                await loadAllQuestions();
                displayQuestions();
                await loadImagesFromIndex(); // Load images from index file only
                updateSaveButtonState(); // Initialize save button state
                console.log('✅ Application initialized successfully');
            } catch (error) {
                console.error('❌ Error initializing application:', error);
                showToast('Lỗi khởi tạo ứng dụng: ' + error.message, 'error');
            }
        }
        
        // Load questions from all JSON files
        async function loadAllQuestions() {
            try {
                // Load question_sets.json first to get question order
                const questionSetsResponse = await fetch('question_sets.json');
                const questionSets = await questionSetsResponse.json();
                
                // Load all question data files and store original data
                const vong1Response = await fetch('vong1.json');
                const vong2Response = await fetch('vong2.json');
                const vong3Response = await fetch('vong3.json');
                
                if (vong1Response.ok) {
                    originalData.vong1 = await vong1Response.json();
                    vong1Data = JSON.parse(JSON.stringify(originalData.vong1)); // Deep clone
                }
                
                if (vong2Response.ok) {
                    originalData.vong2 = await vong2Response.json();
                    vong2Data = JSON.parse(JSON.stringify(originalData.vong2)); // Deep clone
                }
                
                if (vong3Response.ok) {
                    originalData.vong3 = await vong3Response.json();
                    vong3Data = JSON.parse(JSON.stringify(originalData.vong3)); // Deep clone
                }

                // Create question lookup maps
                const questionMaps = {
                    1: createQuestionMap(vong1Data),
                    2: createQuestionMap(vong2Data),
                    3: createQuestionMap(vong3Data)
                };

                // Build ordered questions list based on question_sets.json
                allQuestions = [];
                buildOrderedQuestionsList(questionSets, questionMaps);

                filteredQuestions = [...allQuestions];
                console.log(`Loaded ${allQuestions.length} questions in order from question_sets.json`);
            } catch (error) {
                throw new Error('Không thể tải file câu hỏi: ' + error.message);
            }        }

        // Filter questions based on selected criteria
        function filterQuestions() {
            const roundFilter = document.getElementById('roundFilter').value;

            filteredQuestions = allQuestions.filter(question => {
                const matchesRound = !roundFilter || question._round.toString() === roundFilter;
                return matchesRound;
            });

            displayQuestions();
            // Clear selections when filter changes
            selectedQuestions.clear();
            document.getElementById('selectAll').checked = false;
        }        // Display questions in table
        function displayQuestions() {
            const tbody = document.getElementById('questionsTableBody');
            tbody.innerHTML = '';

            filteredQuestions.forEach((question, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const originalIndex = allQuestions.indexOf(question);
                const isSelected = selectedQuestions.has(originalIndex);
                  // Generate question number display
                let questionNumberDisplay = 'N/A';
                if (question._round === 3 && question._domain) {
                    questionNumberDisplay = `${question._domain.toUpperCase()} - ${question._questionNumber}/${question._totalInSet}`;
                } else if (question._setNumber && question._questionNumber) {
                    questionNumberDisplay = `${question._questionNumber}/${question._totalInSet}`;
                } else if (question._questionNumber) {
                    questionNumberDisplay = `${question._questionNumber}/${question._totalInSet || '?'}`;
                }
                  row.innerHTML = `
                    <td class="px-4 py-3">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} 
                               onchange="toggleQuestionSelection(${originalIndex})" 
                               class="question-checkbox">
                    </td>
                    <td class="px-4 py-3 font-mono text-sm">${question.id || 'N/A'}</td>
                    <td class="px-4 py-3">${question._round}</td>
                    <td class="px-4 py-3 text-sm font-medium">${questionNumberDisplay}</td>
                    <td class="px-4 py-3">
                        <div class="question-text" title="${question.cau_hoi || ''}">
                            ${truncateText(question.cau_hoi || '', 100)}
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        ${createThumbnail(question.image_id)}
                    </td>
                    <td class="px-4 py-3">
                        ${createThumbnail(question.bg_image)}
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="editQuestion(${originalIndex})" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }// Create thumbnail HTML
        function createThumbnail(imagePath) {
            if (!imagePath || imagePath === 'null') {
                return `<div class="placeholder-thumbnail"><i class="fas fa-image"></i></div>`;
            }
            
            return `
                <div class="thumbnail-container">
                    <img src="${imagePath}" 
                         class="thumbnail-image" 
                         onload="this.style.display='block'" 
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;placeholder-thumbnail&quot;><i class=&quot;fas fa-image&quot;></i></div>'">
                </div>
            `;
        }

        // Truncate text
        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Toggle question selection
        function toggleQuestionSelection(index) {
            if (selectedQuestions.has(index)) {
                selectedQuestions.delete(index);
            } else {
                selectedQuestions.add(index);
            }
            
            // Update select all checkbox
            const totalVisible = filteredQuestions.length;
            const selectedVisible = filteredQuestions.filter(q => selectedQuestions.has(allQuestions.indexOf(q))).length;
            document.getElementById('selectAll').checked = selectedVisible === totalVisible && totalVisible > 0;
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            
            if (selectAll) {
                filteredQuestions.forEach(question => {
                    selectedQuestions.add(allQuestions.indexOf(question));
                });
            } else {
                filteredQuestions.forEach(question => {
                    selectedQuestions.delete(allQuestions.indexOf(question));
                });
            }
            
            displayQuestions();
        }

        // Toggle batch edit panel
        function toggleBatchEdit() {
            const panel = document.getElementById('batchEditPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (isVisible) {
                // Reset batch edit form
                document.getElementById('batchUseImage').value = '';
                document.getElementById('batchPositionImage').value = '';
                document.getElementById('batchQuestionImage').value = '';
                document.getElementById('batchBgOverlay').value = '';
            }
        }        // Apply batch edit
        function applyBatchEdit() {
            if (selectedQuestions.size === 0) {
                showToast('Vui lòng chọn ít nhất một câu hỏi', 'error');
                return;
            }

            const useImage = document.getElementById('batchUseImage').value;
            const positionImage = document.getElementById('batchPositionImage').value;
            const questionImage = document.getElementById('batchQuestionImage').value;
            const bgOverlay = document.getElementById('batchBgOverlay').value;

            let changedQuestionsCount = 0;
            selectedQuestions.forEach(index => {
                const question = allQuestions[index];
                
                // Store original values for comparison
                const originalValues = {
                    use_image: question.use_image,
                    position_image: question.position_image,
                    question_image: question.question_image,
                    bg_image_overlay: question.bg_image_overlay
                };
                
                // Apply changes
                if (useImage) {
                    question.use_image = useImage;
                }
                if (positionImage) {
                    question.position_image = positionImage;
                }
                if (questionImage) {
                    question.question_image = questionImage;
                }
                if (bgOverlay) {
                    question.bg_image_overlay = bgOverlay === 'null' ? null : bgOverlay;
                }
                
                // Check if anything actually changed
                let hasChanges = false;
                for (const key in originalValues) {
                    if (originalValues[key] !== question[key]) {
                        hasChanges = true;
                        break;
                    }
                }
                
                if (hasChanges) {
                    trackQuestionChange(question.id);
                    changedQuestionsCount++;
                }
            });

            displayQuestions();
            toggleBatchEdit();
            showToast(`Đã cập nhật ${changedQuestionsCount} câu hỏi`);
        }        // Edit single question
        function editQuestion(index) {
            currentEditIndex = index;
            const question = allQuestions[index];
            
            // Populate form
            document.getElementById('editIndex').value = index;
            document.getElementById('editUseImage').checked = question.use_image === 'Yes';
            document.getElementById('editImageId').value = question.image_id || '';
            document.getElementById('editPositionRight').checked = question.position_image === 'Right';
            document.getElementById('editQuestionImage').checked = question.question_image === 'Yes';
            document.getElementById('editBgImage').value = question.bg_image || '';
            
            // Handle overlay checkboxes
            document.getElementById('editGradientOverlay').checked = question.bg_image_overlay === 'gradient';
            document.getElementById('editStripesOverlay').checked = question.bg_image_overlay === 'stripes';
            
            // Update image previews
            updateImagePreview('editImagePreview', question.image_id);
            updateImagePreview('editBgImagePreview', question.bg_image);
              // Show modal
            document.getElementById('editModal').style.display = 'flex';
            
            // Setup overlay checkboxes after modal is shown
            setupOverlayCheckboxes();
        }// Update image preview
        function updateImagePreview(containerId, imagePath) {
            const container = document.getElementById(containerId);
            if (!imagePath || imagePath === 'null') {
                container.innerHTML = '<div class="placeholder-thumbnail"><i class="fas fa-image"></i></div>';
            } else {
                container.innerHTML = `
                    <img src="${imagePath}" 
                         class="thumbnail-image" 
                         onerror="this.parentElement.innerHTML='<div class=&quot;placeholder-thumbnail&quot;><i class=&quot;fas fa-image&quot;></i></div>'">
                `;
            }
        }        // Save question changes
        function saveQuestion() {
            const index = parseInt(document.getElementById('editIndex').value);
            const question = allQuestions[index];
            
            // Store original values for comparison
            const originalValues = {
                use_image: question.use_image,
                image_id: question.image_id,
                position_image: question.position_image,
                question_image: question.question_image,
                bg_image: question.bg_image,
                bg_image_overlay: question.bg_image_overlay
            };
            
            // Update question properties
            question.use_image = document.getElementById('editUseImage').checked ? 'Yes' : 'No';
            question.image_id = document.getElementById('editImageId').value || null;
            question.position_image = document.getElementById('editPositionRight').checked ? 'Right' : 'Left';
            question.question_image = document.getElementById('editQuestionImage').checked ? 'Yes' : 'No';
            question.bg_image = document.getElementById('editBgImage').value || null;
            
            // Handle overlay checkboxes
            let bgOverlay = null;
            if (document.getElementById('editGradientOverlay').checked) {
                bgOverlay = 'gradient';
            } else if (document.getElementById('editStripesOverlay').checked) {
                bgOverlay = 'stripes';
            }
            question.bg_image_overlay = bgOverlay;
            
            // Check if anything actually changed
            let hasChanges = false;
            for (const key in originalValues) {
                if (originalValues[key] !== question[key]) {
                    hasChanges = true;
                    break;
                }
            }
            
            if (hasChanges) {
                trackQuestionChange(question.id);
                showToast('Đã lưu thay đổi câu hỏi');
            } else {
                showToast('Không có thay đổi nào');
            }
            
            closeEditModal();
            displayQuestions();
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditIndex = -1;
        }        // Simplified: just load from index file
        async function scanImageFolders() {
            showToast('📋 Đang tải danh sách ảnh...', 'info');
            return await loadImagesFromIndex();
        }

        // Check if image exists with improved timeout and caching
        function imageExists(path) {
            return new Promise((resolve) => {
                const img = new Image();
                
                // Set up timeout
                const timeout = setTimeout(() => {
                    img.onload = null;
                    img.onerror = null;
                    resolve(false);
                }, 800); // Reduced timeout for faster scanning
                
                img.onload = () => {
                    clearTimeout(timeout);
                    resolve(true);
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    resolve(false);
                };
                
                // Add cache busting for more accurate detection
                img.src = path + '?t=' + Date.now();
            });
        }        // Simplified refresh - just reload from index
        async function refreshImagesLibrary() {
            return await manualRefreshImages(); // Delegate to the manual refresh function
        }// Show image gallery
        function showImageGallery(context, field) {
            currentGalleryContext = context;
            currentGalleryField = field;
            selectedImagePath = null;
              populateFolderTree();
            showImagesInFolder('images');
            
            // Auto-refresh disabled for performance
            console.log('Auto-refresh disabled for performance optimization');
            
            document.getElementById('imageGalleryModal').style.display = 'flex';
        }

        // Populate folder tree
        function populateFolderTree() {
            const folderTree = document.getElementById('folderTree');
            folderTree.innerHTML = '';
            
            Object.keys(availableImages).forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <i class="fas fa-folder mr-2"></i>
                    ${folder.split('/').pop()}
                `;
                folderItem.dataset.folder = folder; // Store folder path in data attribute
                folderItem.onclick = () => showImagesInFolder(folder);
                folderTree.appendChild(folderItem);
            });
        }

        // Show images in folder
        function showImagesInFolder(folder) {
            // Update active folder
            document.querySelectorAll('.folder-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.folder === folder) {
                    item.classList.add('active');
                }
            });
            
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            
            const images = availableImages[folder] || [];
            images.forEach(imageName => {
                const imagePath = `${folder}/${imageName}`;
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.onclick = () => selectImageFromGrid(imagePath, imageItem);
                
                imageItem.innerHTML = `
                    <img src="${imagePath}" 
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjU2IiB2aWV3Qm94PSIwIDAgMTAwIDU2IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAiIGhlaWdodD0iNTYiIGZpbGw9IiNmM2Y0ZjYiLz48dGV4dCB4PSI1MCIgeT0iMzAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM2YjcyODAiIGZvbnQtc2l6ZT0iMTIiPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg=='"
                         alt="${imageName}">
                    <span>${imageName}</span>
                `;
                
                imageGrid.appendChild(imageItem);
            });
        }

        // Select image from grid
        function selectImageFromGrid(imagePath, element) {
            // Remove previous selection
            document.querySelectorAll('.image-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            element.classList.add('selected');
            selectedImagePath = imagePath;
        }

        // Select image (confirm selection)
        function selectImage() {
            if (!selectedImagePath) {
                showToast('Vui lòng chọn một hình ảnh', 'error');
                return;
            }
            
            if (currentGalleryContext === 'edit') {
                // Update edit form
                if (currentGalleryField === 'image_id') {
                    document.getElementById('editImageId').value = selectedImagePath;
                    updateImagePreview('editImagePreview', selectedImagePath);
                } else if (currentGalleryField === 'bg_image') {
                    document.getElementById('editBgImage').value = selectedImagePath;
                    updateImagePreview('editBgImagePreview', selectedImagePath);
                }
            } else if (currentGalleryContext === 'batch') {
                // Apply to selected questions
                if (selectedQuestions.size === 0) {
                    showToast('Vui lòng chọn ít nhất một câu hỏi', 'error');
                    return;
                }
                
                selectedQuestions.forEach(index => {
                    const question = allQuestions[index];
                    question[currentGalleryField] = selectedImagePath;
                });
                
                displayQuestions();
                showToast(`Đã gán ảnh cho ${selectedQuestions.size} câu hỏi`);
            }
            
            closeImageGallery();
        }

        // Close image gallery
        function closeImageGallery() {
            document.getElementById('imageGalleryModal').style.display = 'none';
            currentGalleryContext = null;
            currentGalleryField = null;
            selectedImagePath = null;
        }        // Upload functionality removed for performance optimization// Save all files
        async function saveAllFiles() {
            if (changedQuestions.size === 0) {
                showToast('Không có thay đổi nào để lưu', 'error');
                return;
            }
            
            try {
                console.log('Starting save operation...');
                console.log('Changed questions:', Array.from(changedQuestions));
                
                const changedFiles = getChangedFilesData();
                const fileCount = Object.keys(changedFiles).length;
                
                if (fileCount === 0) {
                    showToast('Không có file nào cần lưu', 'error');
                    return;
                }
                
                console.log(`Saving ${fileCount} files:`, Object.keys(changedFiles));
                
                // Validate all files before saving
                for (const [filename, data] of Object.entries(changedFiles)) {
                    try {
                        const round = filename === 'vong1.json' ? 1 : filename === 'vong2.json' ? 2 : 3;
                        validateJSONStructure(data, round);
                    } catch (validationError) {
                        console.error(`❌ Validation failed for ${filename}:`, validationError);
                        showToast(`Lỗi validation ${filename}: ${validationError.message}`, 'error');
                        return; // Stop on validation error
                    }
                }
                
                // Check if File System Access API is supported
                if ('showSaveFilePicker' in window) {
                    for (const [filename, data] of Object.entries(changedFiles)) {
                        console.log(`Saving ${filename}...`);
                        try {
                            await saveFileWithAPI(filename, data);
                            console.log(`✅ Successfully saved ${filename}`);
                        } catch (fileError) {
                            console.error(`❌ Failed to save ${filename}:`, fileError);
                            if (fileError.name !== 'AbortError') {
                                showToast(`Lỗi khi lưu ${filename}: ${fileError.message}`, 'error');
                                return; // Stop on error
                            }
                        }
                    }
                } else {
                    // Fallback to download
                    console.log('Using download fallback...');
                    for (const [filename, data] of Object.entries(changedFiles)) {
                        try {
                            downloadFile(data, filename);
                            console.log(`📥 Downloaded ${filename}`);
                            await new Promise(resolve => setTimeout(resolve, 100)); // Small delay between downloads
                        } catch (fileError) {
                            console.error(`❌ Failed to download ${filename}:`, fileError);
                            showToast(`Lỗi khi tải xuống ${filename}: ${fileError.message}`, 'error');
                            return;
                        }
                    }
                }
                
                showToast(`✅ Đã lưu thành công ${fileCount} file`);
                
                // Clear changed tracking after successful save
                changedQuestions.clear();
                updateSaveButtonState();
                
            } catch (error) {
                console.error('Error in save operation:', error);
                showToast('Lỗi khi lưu file: ' + error.message, 'error');
            }
        }// Save with File System Access API
        async function saveWithFileSystemAPI(data, suggestedName) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: suggestedName,
                    types: [{
                        description: 'JSON files',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                  const writable = await fileHandle.createWritable();
                const formattedContent = formatJSONWithPrettier(data);
                await writable.write(formattedContent);
                await writable.close();
                
                return true;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    throw error;
                }
                return false;
            }
        }        // Format JSON với Prettier và custom handling cho arrays ngắn
        function formatJSONWithPrettier(data) {
            try {
                // Prettier config tương tự VS Code
                const prettierConfig = {
                    parser: 'json',
                    tabWidth: 2,
                    useTabs: false,
                    printWidth: 80,
                    trailingComma: 'none',
                    bracketSpacing: true,
                    semi: true,
                    singleQuote: false
                };

                // Format với Prettier
                const jsonString = JSON.stringify(data);
                let formatted = prettier.format(jsonString, prettierConfig);
                
                // Custom post-processing để compact short arrays như dap_an_dung
                // Xử lý dap_an_dung dạng ARRAY với bất kỳ số lượng phần tử nào (a-z)
                formatted = formatted.replace(
                    /"dap_an_dung":\s*\[\s*\n(\s*"[a-z]",?\s*\n)+\s*\]/g,
                    (match) => {
                        const values = match.match(/"[a-z]"/g);
                        if (values) {
                            return `"dap_an_dung": [${values.join(', ')}]`;
                        }
                        return match;
                    }
                );
                
                // KHÔNG thay đổi dap_an_dung dạng STRING (để giữ format gốc của vong1.json)
                // Vì vong1.json có mix: "dap_an_dung": "a" và "dap_an_dung": ["b", "c"]
                
                // Compact các arrays ngắn khác (≤ 8 elements, mỗi element ≤ 15 chars)
                // Nhưng SKIP dap_an_dung vì đã xử lý riêng ở trên
                formatted = formatted.replace(
                    /("(?!dap_an_dung)[\w_]+"):\s*\[\s*\n(\s*"[^"]{1,15}",?\s*\n){1,8}\s*\]/g,
                    (match) => {
                        const values = match.match(/"[^"]*"/g);
                        if (values && values.length > 1) {
                            // Lấy key (tên trường)
                            const keyMatch = match.match(/^"[\w_]+"/);
                            if (keyMatch) {
                                const key = keyMatch[0];
                                // Loại bỏ key khỏi values array
                                const arrayValues = values.slice(1);
                                return `${key}: [${arrayValues.join(', ')}]`;
                            }
                        }
                        return match;
                    }
                );
                
                return formatted;
            } catch (error) {
                console.warn('Prettier format failed, fallback to JSON.stringify:', error);
                // Fallback với formatting tốt hơn
                try {
                    return JSON.stringify(data, null, 2);
                } catch (jsonError) {
                    console.error('JSON.stringify also failed:', jsonError);
                    throw new Error('Unable to format JSON: ' + jsonError.message);
                }
            }
        }        // Helper function to download file
        function downloadFile(data, filename) {
            try {
                const formattedContent = formatJSONWithPrettier(data);
                
                // Validate JSON before download
                JSON.parse(formattedContent); // This will throw if invalid
                
                const blob = new Blob([formattedContent], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                console.log(`✅ Successfully downloaded ${filename}`);
            } catch (error) {
                console.error(`❌ Error downloading ${filename}:`, error);
                throw new Error(`Failed to download ${filename}: ${error.message}`);
            }
        }

        // Validate JSON structure before saving
        function validateJSONStructure(data, round) {
            try {
                // Basic validation
                if (!data || typeof data !== 'object') {
                    throw new Error('Data is not a valid object');
                }
                
                // Round-specific validation
                if (round === 1) {
                    if (!data.vong_1 || !data.vong_1.chinh_sach_phap_luat_va_y_te) {
                        throw new Error('Vong1 structure is invalid');
                    }
                } else if (round === 2) {
                    if (!data.vong_2) {
                        throw new Error('Vong2 structure is invalid');
                    }
                } else if (round === 3) {
                    if (!data.vong_3) {
                        throw new Error('Vong3 structure is invalid');
                    }
                }
                
                // Test JSON serialization
                const jsonString = JSON.stringify(data);
                JSON.parse(jsonString); // Will throw if not valid JSON
                
                console.log(`✅ JSON structure validation passed for round ${round}`);
                return true;
            } catch (error) {
                console.error(`❌ JSON validation failed for round ${round}:`, error);
                throw new Error(`JSON validation failed: ${error.message}`);
            }
        }

        // Save round data (kept for backward compatibility)
        function saveRound(round) {
            try {
                let dataToSave;
                let filename;
                
                if (round === 1) {
                    dataToSave = reconstructVong1Data();
                    filename = 'vong1.json';
                } else if (round === 2) {
                    dataToSave = reconstructVong2Data();
                    filename = 'vong2.json';
                } else if (round === 3) {
                    dataToSave = reconstructVong3Data();
                    filename = 'vong3.json';
                }
                
                downloadFile(dataToSave, filename);
                showToast(`Đã lưu ${filename}`);
            } catch (error) {
                console.error('Error saving round:', error);
                showToast('Lỗi khi lưu file: ' + error.message, 'error');
            }
        }        // Reconstruct vong1 data - xử lý đặc biệt cho structure vong1
        function reconstructVong1Data() {
            try {
                const result = JSON.parse(JSON.stringify(vong1Data));
                
                // Update questions in their original positions
                const vong1Questions = allQuestions.filter(q => q._round === 1);
                
                function updateNestedStructure(obj, path = []) {
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => {
                            const question = vong1Questions.find(q => 
                                JSON.stringify(q._path) === JSON.stringify(path) && 
                                q._originalIndex === index
                            );
                            if (question) {
                                // Remove metadata before saving
                                const cleanQuestion = { ...question };
                                delete cleanQuestion._round;
                                delete cleanQuestion._originalIndex;
                                delete cleanQuestion._path;
                                
                                // Preserve vong1-specific structure
                                // dap_an_dung có thể là string hoặc array, giữ nguyên format gốc
                                Object.assign(item, cleanQuestion);
                            }
                        });
                    } else if (obj && typeof obj === 'object') {
                        for (const [key, value] of Object.entries(obj)) {
                            updateNestedStructure(value, [...path, key]);
                        }
                    }
                }
                
                updateNestedStructure(result);
                console.log('✅ Vong1 data reconstructed successfully');
                return result;
            } catch (error) {
                console.error('Error reconstructing vong1 data:', error);
                throw new Error(`Failed to reconstruct vong1 data: ${error.message}`);
            }
        }        // Reconstruct vong2 data - xử lý đặc biệt cho structure vong2
        function reconstructVong2Data() {
            try {
                const result = JSON.parse(JSON.stringify(vong2Data));
                
                const vong2Questions = allQuestions.filter(q => q._round === 2);
                
                function updateNestedStructure(obj, path = []) {
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => {
                            const question = vong2Questions.find(q => 
                                JSON.stringify(q._path) === JSON.stringify(path) && 
                                q._originalIndex === index
                            );
                            if (question) {
                                const cleanQuestion = { ...question };
                                delete cleanQuestion._round;
                                delete cleanQuestion._originalIndex;
                                delete cleanQuestion._path;
                                
                                // Preserve vong2-specific structure
                                // dap_an_dung luôn là array trong vong2
                                // phuong_an có thể có nhiều options không theo thứ tự a,b,c,d
                                Object.assign(item, cleanQuestion);
                            }
                        });
                    } else if (obj && typeof obj === 'object') {
                        for (const [key, value] of Object.entries(obj)) {
                            updateNestedStructure(value, [...path, key]);
                        }
                    }
                }
                
                updateNestedStructure(result);
                console.log('✅ Vong2 data reconstructed successfully');
                return result;
            } catch (error) {
                console.error('Error reconstructing vong2 data:', error);
                throw new Error(`Failed to reconstruct vong2 data: ${error.message}`);
            }
        }        // Reconstruct vong3 data - xử lý đặc biệt cho structure vong3
        function reconstructVong3Data() {
            try {
                const result = JSON.parse(JSON.stringify(vong3Data));
                
                const vong3Questions = allQuestions.filter(q => q._round === 3);
                
                function updateNestedStructure(obj, path = []) {
                    if (Array.isArray(obj)) {
                        obj.forEach((item, index) => {
                            const question = vong3Questions.find(q => 
                                JSON.stringify(q._path) === JSON.stringify(path) && 
                                q._originalIndex === index
                            );
                            if (question) {
                                const cleanQuestion = { ...question };
                                delete cleanQuestion._round;
                                delete cleanQuestion._originalIndex;
                                delete cleanQuestion._path;
                                delete cleanQuestion._domain; // vong3 specific metadata
                                
                                // Preserve vong3-specific structure
                                // Không có dap_an_dung, chỉ có cau_hoi
                                // Structure đơn giản hơn: chỉ có thực hành và tự luận
                                Object.assign(item, cleanQuestion);
                            }
                        });
                    } else if (obj && typeof obj === 'object') {
                        for (const [key, value] of Object.entries(obj)) {
                            updateNestedStructure(value, [...path, key]);
                        }
                    }
                }
                
                updateNestedStructure(result);
                console.log('✅ Vong3 data reconstructed successfully');
                return result;
            } catch (error) {
                console.error('Error reconstructing vong3 data:', error);
                throw new Error(`Failed to reconstruct vong3 data: ${error.message}`);
            }
        }

        // Create question map from JSON data
        function createQuestionMap(data) {
            const questionMap = new Map();
            
            function findQuestions(obj, path = []) {
                if (Array.isArray(obj)) {
                    obj.forEach((question, index) => {
                        if (question && typeof question === 'object' && question.id) {
                            question._originalIndex = index;
                            question._path = [...path];
                            questionMap.set(question.id, question);
                        }
                    });
                } else if (obj && typeof obj === 'object') {
                    for (const [key, value] of Object.entries(obj)) {
                        findQuestions(value, [...path, key]);
                    }
                }
            }
            
            findQuestions(data);
            return questionMap;
        }

        // Build ordered questions list based on question_sets.json
        function buildOrderedQuestionsList(questionSets, questionMaps) {
            // Process Vong 1
            if (questionSets.vong1) {
                Object.entries(questionSets.vong1).forEach(([setNumber, questionIds]) => {
                    questionIds.forEach((questionId, index) => {
                        const question = questionMaps[1].get(questionId);
                        if (question) {
                            const orderedQuestion = { ...question };
                            orderedQuestion._round = 1;
                            orderedQuestion._setNumber = setNumber;
                            orderedQuestion._questionNumber = index + 1;
                            orderedQuestion._totalInSet = questionIds.length;
                            allQuestions.push(orderedQuestion);
                        } else {
                            console.warn(`Question ${questionId} not found in vong1 data`);
                        }
                    });
                });
            }

            // Process Vong 2
            if (questionSets.vong2) {
                Object.entries(questionSets.vong2).forEach(([setNumber, questionIds]) => {
                    questionIds.forEach((questionId, index) => {
                        const question = questionMaps[2].get(questionId);
                        if (question) {
                            const orderedQuestion = { ...question };
                            orderedQuestion._round = 2;
                            orderedQuestion._setNumber = setNumber;
                            orderedQuestion._questionNumber = index + 1;
                            orderedQuestion._totalInSet = questionIds.length;
                            allQuestions.push(orderedQuestion);
                        } else {
                            console.warn(`Question ${questionId} not found in vong2 data`);
                        }
                    });
                });
            }

            // Process Vong 3
            if (questionSets.vong3) {
                Object.entries(questionSets.vong3).forEach(([domain, questionIds]) => {
                    questionIds.forEach((questionId, index) => {
                        const question = questionMaps[3].get(questionId);
                        if (question) {
                            const orderedQuestion = { ...question };
                            orderedQuestion._round = 3;
                            orderedQuestion._domain = domain;
                            orderedQuestion._questionNumber = index + 1;
                            orderedQuestion._totalInSet = questionIds.length;
                            allQuestions.push(orderedQuestion);
                        } else {
                            console.warn(`Question ${questionId} not found in vong3 data`);
                        }
                    });
                });
            }
        }

        // Debug function to show scan results
        function showScanDebugInfo() {
            console.log('📊 Current image scan results:');
            console.log('='.repeat(50));
            
            Object.keys(availableImages).forEach(folder => {
                const images = availableImages[folder] || [];
                console.log(`📁 ${folder}: ${images.length} images`);
                
                if (images.length > 0) {
                    // Show first few and last few
                    const preview = images.length > 10 
                        ? [...images.slice(0, 5), '...', ...images.slice(-5)]
                        : images;
                    console.log(`   └── ${preview.join(', ')}`);
                }
            });
            
            const total = Object.values(availableImages).flat().length;
            console.log('='.repeat(50));
            console.log(`📊 Total: ${total} images across ${Object.keys(availableImages).length} folders`);
            
            return { 
                folders: Object.keys(availableImages).length,
                total: total,
                details: availableImages 
            };
        }

        // Add to window for manual debugging
        window.debugImageScan = showScanDebugInfo;

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            if (type === 'error') {
                toast.firstElementChild.className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                toast.firstElementChild.className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            toast.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
            }, 3000);
        }        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            init();
            // Start global auto-refresh on page load
            startGlobalAutoRefresh();
        });

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            stopGlobalAutoRefresh();
        });

        // Enhanced refresh images list function
        async function enhancedRefreshImagesList() {
            console.log('🔄 Enhanced refresh - using index only...');
            return await loadImagesFromIndex();
        }

        // Smart scanning - SIMPLIFIED to use index only
        async function smartImageDetection() {
            console.log('🧠 Smart detection - using index only...');
            return await loadImagesFromIndex();
        }

        // Auto-refresh system
        let globalRefreshInterval = null;
          // Start global auto-refresh - DISABLED for performance
        function startGlobalAutoRefresh() {
            console.log('🔄 Global auto-refresh disabled for performance');
        }
        
        // Stop global auto-refresh
        function stopGlobalAutoRefresh() {
            if (globalRefreshInterval) {
                clearInterval(globalRefreshInterval);
                globalRefreshInterval = null;
                console.log('⏹️ Global auto-refresh stopped');
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', init);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Add Q key navigation to go back to menu.html
            if (e.key.toLowerCase() === 'q') {
                window.location.href = 'menu.html';
            }
            if (e.key === 'Escape') {
                if (document.getElementById('editModal').style.display === 'flex') {
                    closeEditModal();
                }
                if (document.getElementById('imageGalleryModal').style.display === 'flex') {
                    closeImageGallery();
                }
            }
        });

        // Simple image loading from index file only
        async function loadImagesFromIndex() {
            try {
                console.log('📋 Loading images from index file...');
                const response = await fetch('images_index.json?t=' + Date.now());
                if (response.ok) {
                    availableImages = await response.json();
                    console.log(`✅ Loaded images from index: ${Object.values(availableImages).flat().length} total images`);
                    return true;
                } else {
                    throw new Error('Failed to load images index');
                }
            } catch (error) {
                console.error('❌ Error loading images index:', error);
                // Fallback to empty structure
                availableImages = {
                    'images': [],
                    'images/bg': [],
                    'images/cauhoi': [],
                    'images/index_images': []
                };
                return false;
            }
        }

        // Manual refresh images - now just reloads from index
        async function manualRefreshImages() {
            const refreshBtn = document.querySelector('button[onclick="manualRefreshImages()"]');
            const originalContent = refreshBtn.innerHTML;
            
            // Show loading state
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            refreshBtn.disabled = true;
            
            try {
                showToast('� Đang tải danh sách ảnh từ index...', 'info');
                
                const success = await loadImagesFromIndex();
                
                if (success) {
                    // Update gallery if it's open
                    if (document.getElementById('imageGalleryModal').style.display === 'flex') {
                        populateFolderTree();
                        // Refresh current folder view
                        const activeFolder = document.querySelector('.folder-item.active');
                        if (activeFolder && activeFolder.dataset.folder) {
                            showImagesInFolder(activeFolder.dataset.folder);
                        }
                    }
                    
                    const total = Object.values(availableImages).flat().length;
                    showToast(`✅ Đã tải thành công: ${total} ảnh từ index`);
                } else {
                    showToast('❌ Không thể tải images index file', 'error');
                }
                
            } catch (error) {
                console.error('Error in manual refresh:', error);
                showToast('❌ Lỗi khi tải ảnh: ' + error.message, 'error');
                
            } finally {
                // Restore button state
                refreshBtn.innerHTML = originalContent;
                refreshBtn.disabled = false;
            }
        }

        // Track question changes
        function trackQuestionChange(questionId) {
            changedQuestions.add(questionId);
            updateSaveButtonState();
            console.log(`Question ${questionId} marked as changed. Total changes: ${changedQuestions.size}`);
        }

        // Update save button state
        function updateSaveButtonState() {
            const saveBtn = document.querySelector('.save-all-btn');
            if (saveBtn) {
                if (changedQuestions.size > 0) {
                    saveBtn.innerHTML = `<i class="fas fa-save mr-2"></i>Save All (${changedQuestions.size} thay đổi)`;
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-50');
                } else {
                    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save All';
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50');
                }
            }
        }        // Function to get changed files and their data
        function getChangedFilesData() {
            try {
                const changedFiles = {};
                
                // Check which rounds have changes
                const changedRounds = new Set();
                changedQuestions.forEach(questionId => {
                    const question = allQuestions.find(q => q.id === questionId);
                    if (question && question._round) {
                        changedRounds.add(question._round);
                    } else {
                        console.warn(`Question ${questionId} not found or missing _round property`);
                    }
                });
                
                console.log('Changed rounds:', Array.from(changedRounds));
                console.log('Changed questions:', Array.from(changedQuestions));
                
                // Only include files that have changes
                changedRounds.forEach(round => {
                    try {
                        if (round === 1 && originalData.vong1) {
                            console.log('Processing vong1 changes...');
                            changedFiles['vong1.json'] = updateOriginalData(originalData.vong1, 1);
                        } else if (round === 2 && originalData.vong2) {
                            console.log('Processing vong2 changes...');
                            changedFiles['vong2.json'] = updateOriginalData(originalData.vong2, 2);
                        } else if (round === 3 && originalData.vong3) {
                            console.log('Processing vong3 changes...');
                            changedFiles['vong3.json'] = updateOriginalData(originalData.vong3, 3);
                        } else {
                            console.warn(`No original data available for round ${round}`);
                        }
                    } catch (roundError) {
                        console.error(`Error processing round ${round}:`, roundError);
                        throw new Error(`Failed to process round ${round}: ${roundError.message}`);
                    }
                });
                
                console.log('Files to save:', Object.keys(changedFiles));
                return changedFiles;
                
            } catch (error) {
                console.error('Error getting changed files data:', error);
                throw new Error(`Failed to prepare save data: ${error.message}`);
            }
        }        // Function to update original data structure with changes
        function updateOriginalData(originalData, round) {
            try {
                const updatedData = JSON.parse(JSON.stringify(originalData)); // Deep clone
                
                // Update only changed questions in their original positions
                function updateNestedStructure(obj, path = []) {
                    if (!obj || typeof obj !== 'object') return;
                    
                    for (const key in obj) {
                        if (!obj.hasOwnProperty(key)) continue;
                        
                        if (Array.isArray(obj[key])) {
                            // This is an array of questions
                            obj[key].forEach((item, index) => {
                                if (item && item.id && changedQuestions.has(item.id)) {
                                    const updatedQuestion = allQuestions.find(q => q.id === item.id);
                                    if (updatedQuestion) {
                                        console.log(`Updating question ${item.id} in ${path.join('.')} (Round ${round})`);
                                        
                                        // Only update the image-related fields we allow editing
                                        const fieldsToUpdate = [
                                            'image_id', 
                                            'use_image', 
                                            'position_image', 
                                            'question_image', 
                                            'bg_image', 
                                            'bg_image_overlay'
                                        ];
                                        
                                        fieldsToUpdate.forEach(field => {
                                            if (updatedQuestion.hasOwnProperty(field)) {
                                                // Đảm bảo giá trị được copy chính xác
                                                if (updatedQuestion[field] === null) {
                                                    obj[key][index][field] = null;
                                                } else if (updatedQuestion[field] === undefined) {
                                                    // Không thay đổi nếu undefined
                                                } else {
                                                    obj[key][index][field] = updatedQuestion[field];
                                                }
                                            }
                                        });
                                        
                                        // Đặc biệt xử lý cho các trường đặc biệt theo từng round
                                        if (round === 1) {
                                            // Vong1: preserve dap_an_dung structure (string hoặc array)
                                            // Không thay đổi dap_an_dung vì nó không phải image field
                                        } else if (round === 2) {
                                            // Vong2: preserve complex structure
                                            // Không thay đổi phuong_an structure
                                        } else if (round === 3) {
                                            // Vong3: không có dap_an_dung, chỉ có cau_hoi
                                        }
                                    }
                                }
                            });
                        } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                            updateNestedStructure(obj[key], [...path, key]);
                        }
                    }
                }
                
                updateNestedStructure(updatedData);
                
                // Validate result before returning
                if (!updatedData || typeof updatedData !== 'object') {
                    throw new Error('Updated data is invalid');
                }
                
                return updatedData;
                
            } catch (error) {
                console.error(`Error updating original data for round ${round}:`, error);
                throw new Error(`Failed to update data structure for round ${round}: ${error.message}`);
            }
        }

        // Helper function to save file with File System Access API
        async function saveFileWithAPI(filename, data) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{
                        description: 'JSON files',
                        accept: { 'application/json': ['.json'] }

                    }]                });                  const writable = await fileHandle.createWritable();
                const formattedContent = formatJSONWithPrettier(data);
                await writable.write(formattedContent);
                await writable.close();
                
            } catch (error) {
                if (error.name !== 'AbortError') {
                    throw error;
                }
            }
        }

        // Auto-refresh gallery when folder changes
        let galleryRefreshInterval = null;
          // Function to refresh images list - SIMPLIFIED to use index only
        async function refreshImagesList() {
            console.log('🔄 Refreshing images from index...');
            return await loadImagesFromIndex();
        }
          // Start auto-refresh when gallery opens - DISABLED for performance
        function startGalleryAutoRefresh() {
            // Auto-refresh disabled - manual refresh only via button
            console.log('Auto-refresh disabled for performance');
        }
        
        // Manual refresh button
        function manualRefreshGallery() {
            showToast('Đang quét lại thư mục...', 'info');
            refreshImagesList().then(changed => {
                if (changed) {
                    showToast('Đã cập nhật danh sách ảnh');
                } else {
                    showToast('Không có ảnh mới');
                }
            });
        }

        // Handle overlay checkbox mutual exclusivity
        function setupOverlayCheckboxes() {
            const gradientCheckbox = document.getElementById('editGradientOverlay');
            const stripesCheckbox = document.getElementById('editStripesOverlay');
            
            if (gradientCheckbox && stripesCheckbox) {
                gradientCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        stripesCheckbox.checked = false;
                    }
                });
                
                stripesCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        gradientCheckbox.checked = false;
                    }
                });
            }
        }

        // ...existing code...
    </script>
</body>
</html>